<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="es" xml:lang="es"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.6.40">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Documentación</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./favicon.png" rel="icon" type="image/png">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-549806ee2085284f45b00abea8c6df48.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-text-highlighting-styles">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-dark-8ea72dc5fed832574809a9c94082fbbb.css" rel="prefetch" class="quarto-color-scheme quarto-color-alternate" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap-ddd961a2510921635943dfbbd19534c4.min.css" rel="stylesheet" append-hash="true" class="quarto-color-scheme" id="quarto-bootstrap" data-mode="light">
<link href="site_libs/bootstrap/bootstrap-dark-ae2d0dcda2edce4ab590422bb373b64f.min.css" rel="prefetch" append-hash="true" class="quarto-color-scheme quarto-color-alternate" id="quarto-bootstrap" data-mode="dark">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "Sin resultados",
    "search-matching-documents-text": "documentos encontrados",
    "search-copy-link-title": "Copiar el enlace en la búsqueda",
    "search-hide-matches-text": "Ocultar resultados adicionales",
    "search-more-match-text": "resultado adicional en este documento",
    "search-more-matches-text": "resultados adicionales en este documento",
    "search-clear-button-title": "Borrar",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancelar",
    "search-submit-button-title": "Enviar",
    "search-label": "Buscar"
  }
}</script>


<link rel="stylesheet" href="styles.css">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a href="./index.html" class="navbar-brand navbar-brand-logo">
    <img src="./ctlogo.png" alt="" class="navbar-logo">
    </a>
  </div>
            <div id="quarto-search" class="" title="Buscar"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Navegación de palanca" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="./home.html"> 
<span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="./comprension.html"> 
<span class="menu-text">Comprensión del negocio</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="./comprension_datos.html"> 
<span class="menu-text">Comprensión de los datos</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="./preparacion.html"> 
<span class="menu-text">Preparación</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="./modelado.html"> 
<span class="menu-text">Modelado y Evaluación</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="./despliegue.html"> 
<span class="menu-text">Despliegue</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link active" href="./documentacion.html" aria-current="page"> 
<span class="menu-text">Documentación</span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
  <a href="" class="quarto-color-scheme-toggle quarto-navigation-tool  px-1" onclick="window.quartoToggleColorScheme(); return false;" title="Alternar modo oscuro"><i class="bi"></i></a>
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Tabla de Contenidos</h2>
   
  <ul>
  <li><a href="#manual-de-instalación-y-despliegue." id="toc-manual-de-instalación-y-despliegue." class="nav-link active" data-scroll-target="#manual-de-instalación-y-despliegue.">1 Manual de instalación y despliegue.</a>
  <ul>
  <li><a href="#configuraciones-importantes" id="toc-configuraciones-importantes" class="nav-link" data-scroll-target="#configuraciones-importantes">1.1 Configuraciones importantes</a></li>
  <li><a href="#requisitios-del-sistema" id="toc-requisitios-del-sistema" class="nav-link" data-scroll-target="#requisitios-del-sistema">1.2 Requisitios del sistema</a></li>
  <li><a href="#dependencias-principales-del-sistema" id="toc-dependencias-principales-del-sistema" class="nav-link" data-scroll-target="#dependencias-principales-del-sistema">1.3 Dependencias principales del sistema</a></li>
  <li><a href="#instalación-del-backend-api" id="toc-instalación-del-backend-api" class="nav-link" data-scroll-target="#instalación-del-backend-api">1.4 Instalación del backend (API)</a>
  <ul>
  <li><a href="#clonar-el-repositorio" id="toc-clonar-el-repositorio" class="nav-link" data-scroll-target="#clonar-el-repositorio">1.4.1 Clonar el repositorio</a></li>
  <li><a href="#crear-un-entorno-virtual-e-instalar-dependencias" id="toc-crear-un-entorno-virtual-e-instalar-dependencias" class="nav-link" data-scroll-target="#crear-un-entorno-virtual-e-instalar-dependencias">1.4.2. Crear un entorno virtual e instalar dependencias</a></li>
  <li><a href="#asegurarse-de-estar-corriendo-los-programas-necesarios-en-el-ambiente" id="toc-asegurarse-de-estar-corriendo-los-programas-necesarios-en-el-ambiente" class="nav-link" data-scroll-target="#asegurarse-de-estar-corriendo-los-programas-necesarios-en-el-ambiente">1.4.3. Asegurarse de estar corriendo los programas necesarios en el ambiente</a></li>
  <li><a href="#configurar-variables-de-entorno" id="toc-configurar-variables-de-entorno" class="nav-link" data-scroll-target="#configurar-variables-de-entorno">1.4.4. Configurar variables de entorno</a></li>
  <li><a href="#levantar-el-backend-con-gunicorn" id="toc-levantar-el-backend-con-gunicorn" class="nav-link" data-scroll-target="#levantar-el-backend-con-gunicorn">1.4.5. Levantar el backend con Gunicorn</a></li>
  <li><a href="#regenerar-el-certificado-ssl-si-expira-o-es-necesario" id="toc-regenerar-el-certificado-ssl-si-expira-o-es-necesario" class="nav-link" data-scroll-target="#regenerar-el-certificado-ssl-si-expira-o-es-necesario">1.4.6. Regenerar el certificado SSL (si expira o es necesario)</a></li>
  <li><a href="#verificar-logs" id="toc-verificar-logs" class="nav-link" data-scroll-target="#verificar-logs">1.4.7. Verificar logs</a></li>
  </ul></li>
  <li><a href="#instalación-del-frontend-widget" id="toc-instalación-del-frontend-widget" class="nav-link" data-scroll-target="#instalación-del-frontend-widget">1.5 Instalación del frontend (Widget)</a></li>
  <li><a href="#actualización-de-la-base-de-conocimientos-etl" id="toc-actualización-de-la-base-de-conocimientos-etl" class="nav-link" data-scroll-target="#actualización-de-la-base-de-conocimientos-etl">1.6 Actualización de la base de conocimientos (ETL)</a></li>
  <li><a href="#descargas-y-configuraciones-adicionales" id="toc-descargas-y-configuraciones-adicionales" class="nav-link" data-scroll-target="#descargas-y-configuraciones-adicionales">1.7 Descargas y configuraciones adicionales</a></li>
  <li><a href="#notas-adicionales" id="toc-notas-adicionales" class="nav-link" data-scroll-target="#notas-adicionales">1.8 Notas adicionales</a></li>
  </ul></li>
  <li><a href="#documentación-técnica-del-código" id="toc-documentación-técnica-del-código" class="nav-link" data-scroll-target="#documentación-técnica-del-código">2 Documentación técnica del código</a>
  <ul>
  <li><a href="#estructura-de-carpetas-y-módulos" id="toc-estructura-de-carpetas-y-módulos" class="nav-link" data-scroll-target="#estructura-de-carpetas-y-módulos">2.1 Estructura de carpetas y módulos</a></li>
  <li><a href="#modelos-llm-utilizados" id="toc-modelos-llm-utilizados" class="nav-link" data-scroll-target="#modelos-llm-utilizados">2.2 Modelos LLM utilizados</a></li>
  <li><a href="#puntos-de-entrada-y-funciones-clave" id="toc-puntos-de-entrada-y-funciones-clave" class="nav-link" data-scroll-target="#puntos-de-entrada-y-funciones-clave">2.3 Puntos de entrada y funciones clave</a></li>
  </ul></li>
  <li><a href="#guía-de-entrenamiento-y-mejora" id="toc-guía-de-entrenamiento-y-mejora" class="nav-link" data-scroll-target="#guía-de-entrenamiento-y-mejora">3 Guía de entrenamiento y mejora</a>
  <ul>
  <li><a href="#generación-de-la-base-de-datos-vectorial" id="toc-generación-de-la-base-de-datos-vectorial" class="nav-link" data-scroll-target="#generación-de-la-base-de-datos-vectorial">3.1 Generación de la base de datos vectorial</a></li>
  <li><a href="#recomendaciones-para-futura-mejora" id="toc-recomendaciones-para-futura-mejora" class="nav-link" data-scroll-target="#recomendaciones-para-futura-mejora">3.2 Recomendaciones para futura mejora</a></li>
  </ul></li>
  <li><a href="#diagrama-de-arquitectura" id="toc-diagrama-de-arquitectura" class="nav-link" data-scroll-target="#diagrama-de-arquitectura">4 Diagrama de arquitectura</a>
  <ul>
  <li><a href="#componentes-clave" id="toc-componentes-clave" class="nav-link" data-scroll-target="#componentes-clave">4.1 Componentes clave</a></li>
  <li><a href="#flujo-de-interacción-principal" id="toc-flujo-de-interacción-principal" class="nav-link" data-scroll-target="#flujo-de-interacción-principal">4.2 Flujo de interacción principal</a></li>
  <li><a href="#flujo-de-datos" id="toc-flujo-de-datos" class="nav-link" data-scroll-target="#flujo-de-datos">4.3 Flujo de datos</a></li>
  </ul></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Documentación</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<section id="manual-de-instalación-y-despliegue." class="level2" style="text-align: justify">
<h2 class="anchored" data-anchor-id="manual-de-instalación-y-despliegue.">1 Manual de instalación y despliegue.</h2>
<section id="configuraciones-importantes" class="level3">
<h3 class="anchored" data-anchor-id="configuraciones-importantes">1.1 Configuraciones importantes</h3>
<ul>
<li>El proyecto está diseñado para ser desplegado en entornos <strong>Linux o Windows</strong> con <strong>Python 3.12.9</strong>. Requiere acceso a <strong>Ollama</strong> (para la ejecución de modelos <em>open-source</em> como <code>gemma3:12b</code>), así como conectividad a una instancia de <strong>MongoDB</strong> y bases de datos <strong>MySQL</strong>.</li>
<li>La aplicación <em>backend</em> se expone a través de <strong>FastAPI</strong> en el puerto <code>8000</code>. Es crucial asegurar que este puerto esté abierto y accesible en el entorno de despliegue.</li>
<li>Archivo <code>.env</code> con variables cargadas</li>
<li>Todas las credenciales y configuraciones sensibles se gestionan mediante un archivo de variables de entorno (<code>.env</code>), garantizando la seguridad y facilidad de configuración.</li>
</ul>
</section>
<section id="requisitios-del-sistema" class="level3">
<h3 class="anchored" data-anchor-id="requisitios-del-sistema">1.2 Requisitios del sistema</h3>
<ul>
<li><strong>Python</strong>: Versión 3.12.9</li>
<li><strong>Pip</strong>: Última versión</li>
<li><strong>UV</strong>: Última versión (gestor de paquetes y entornos)</li>
<li><strong>Ollama</strong>: Instalado y en ejecución en el servidor para el <em>hosting</em> de modelos <em>open-source</em>.</li>
<li><strong>MongoDB</strong>: Acceso remoto configurado para las colecciones de historial, productos, ofertas y fichas técnicas.</li>
<li><strong>MySQL</strong>: Acceso remoto configurado para la extracción de datos de productos y precios.</li>
</ul>
</section>
<section id="dependencias-principales-del-sistema" class="level3">
<h3 class="anchored" data-anchor-id="dependencias-principales-del-sistema">1.3 Dependencias principales del sistema</h3>
<ul>
<li><code>langchain</code>: Framework principal para la construcción de cadenas RAG y la orquestación del flujo del chatbot.</li>
<li><code>tiktoken</code>: Utilizado para el conteo preciso de tokens en las consutlas y respuestas, fundamental para la estimación de costos.</li>
<li><code>ollama</code>: Herramienta para servir modelos de lenguaje <em>open-source</em> localmente, como <code>gemma3:12b</code>, permitiendo flexibilidad en la elección del LLM.</li>
<li><code>pymongo</code>: Driver Python para la interacción con MongoDB, utilizado para el almacenamiento y recuperación de sesiones de usuario, historial de mensajes, fichas técnicas, y datos de productos/ofertas.</li>
<li><code>mysql-connector-python</code>: Conector para MySQL, empleado para la extracción de datos de producto, sus detalles y precios desde la base de datos relacional.</li>
<li><code>faiss-cpu</code>: Biblioteca para la búsqueda eficiente de similitudes, crucial para la creación y consulta de la base de datos vectorial donde se almacenan los embeddings de productos.</li>
<li><code>gunicorn</code>: Servidor WSGI utilizado para desplegar la aplicación FastAPI en producción, gestionando la concurrencia y el rendimiento.</li>
<li><code>podman</code>: Herramienta de virtualización y contenedores sin daemon, utilizada para ejecutar la aplicación dentro de entornos aislados (containers) de manera similar a Docker, pero con mayor seguridad y compatibilidad con sistemas Linux. Facilita el despliegue reproducible de la aplicación y sus servicios asociados (como la base de datos o el servidor vectorial).</li>
<li><strong>Otras dependencias</strong>: Todas las demás librerías requeridas se detallan en el archivo <code>pyproject.toml</code>. La instalación de este archivo se detalla más adelante.</li>
</ul>
</section>
<section id="instalación-del-backend-api" class="level3">
<h3 class="anchored" data-anchor-id="instalación-del-backend-api">1.4 Instalación del backend (API)</h3>
<section id="clonar-el-repositorio" class="level4">
<h4 class="anchored" data-anchor-id="clonar-el-repositorio">1.4.1 Clonar el repositorio</h4>
<div class="sourceCode" id="cb1"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">git</span> clone https://github.com/anmerino-pnd/proyectoCT</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="bu">cd</span> proyectoCT</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="crear-un-entorno-virtual-e-instalar-dependencias" class="level4">
<h4 class="anchored" data-anchor-id="crear-un-entorno-virtual-e-instalar-dependencias">1.4.2. Crear un entorno virtual e instalar dependencias</h4>
<p>Se recomienda usar <code>uv</code> por su eficiencia.</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="ex">pip</span> install uv <span class="co"># En caso de no estar instalado</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="ex">uv</span> venv</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="bu">source</span> .venv/bin/activate  <span class="co"># Para Linux/macOS</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="co"># o `.venv\Scripts\activate` para Windows</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a><span class="ex">uv</span> pip install <span class="at">-e</span> .</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="asegurarse-de-estar-corriendo-los-programas-necesarios-en-el-ambiente" class="level4">
<h4 class="anchored" data-anchor-id="asegurarse-de-estar-corriendo-los-programas-necesarios-en-el-ambiente">1.4.3. Asegurarse de estar corriendo los programas necesarios en el ambiente</h4>
<p>Verifica que el servicio de Ollama esté instalado y activo, y que el modelo <code>gemma3:12b</code> esté disponible.</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="ex">curl</span> <span class="at">-fsSL</span> https://ollama.com/install.sh <span class="kw">|</span> <span class="fu">sh</span> <span class="co"># Para instalar Ollama</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="ex">ollama</span> serve</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="ex">ollama</span> list <span class="co"># Para verificar que el modelo gemma3:12b esté descargado y listo</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a><span class="ex">ollama</span> pull gemma3:12b <span class="co"># Correr esta línea en caso que el modelo no aparezca</span></span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Configurar el servicio de Redis el cual se encarga del cache de la información.</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="fu">mkdir</span> <span class="at">-p</span> ~/proyectoCT/datos/redis_data</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="fu">chmod</span> 700 ~/proyectoCT/datos/redis_data</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Crear un volumen para persistir los datos en cache</span></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a><span class="ex">podman</span> run <span class="at">-d</span> <span class="dt">\</span></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">--name</span> redis-semantic <span class="dt">\</span></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">-p</span> 6380:6379 <span class="dt">\</span></span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">-v</span> redis-data:/data <span class="dt">\</span></span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">--restart</span> unless-stopped <span class="dt">\</span></span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>  redis:latest redis-server <span class="at">--appendonly</span> yes <span class="at">--save</span> <span class="st">""</span></span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a><span class="co">#Nota: Se usa puerto **6380** en lugar de 6379 porque el puerto estándar ya está ocupado por el servicio Redis del sistema.</span></span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Verificar que esté corriendo</span></span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a><span class="ex">podman</span> ps <span class="at">-a</span></span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a><span class="ex">podman</span> exec <span class="at">-it</span> redis-semantic redis-cli ping <span class="co"># Debe responder PONG</span></span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a><span class="ex">podman</span> logs redis-semantic</span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true" tabindex="-1"></a><span class="ex">python3</span> <span class="at">-c</span> <span class="st">"import redis; r = redis.Redis(host='localhost', port=6380); print(r.ping())"</span></span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><strong>NOTA</strong>: En el caso que aparezca este error de Redis en los logs de las conversaciones:</p>
<pre class="console"><code>Redis update failed: Command # 1 (HSET cebdab3b4c033ee7ada24b16b3fc09f0 0 {"lc": 1, "type":
"constructor", "id": ["langchain",...) of pipeline caused error: MISCONF Redis is configured to 
save RDB snapshots, but it's currently unable to persist to disk. Commands that may modify the 
data set are disabled, because this instance is configured to report errors during writes if RDB 
snapshotting fails (stop-writes-on-bgsave-error option). Please check the Redis logs for details 
about the RDB error.</code></pre>
<p>Seguir estos pasos:</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 1. Detener y eliminar el contenedor actual</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="ex">podman</span> stop redis-semantic</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a><span class="ex">podman</span> rm redis-semantic</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a><span class="co"># 2. Crear con volumen nombrado (Podman maneja permisos automáticamente)</span></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a><span class="ex">podman</span> run <span class="at">-d</span> <span class="dt">\</span></span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">--name</span> redis-semantic <span class="dt">\</span></span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">-p</span> 6380:6379 <span class="dt">\</span></span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">-v</span> redis-data:/data <span class="dt">\</span></span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">--restart</span> unless-stopped <span class="dt">\</span></span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a>  redis:latest redis-server <span class="at">--appendonly</span> yes <span class="at">--save</span> <span class="st">""</span></span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a><span class="co"># 3. Verificar que esté corriendo</span></span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a><span class="ex">podman</span> ps</span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true" tabindex="-1"></a><span class="co"># 4. Probar que funcione</span></span>
<span id="cb6-17"><a href="#cb6-17" aria-hidden="true" tabindex="-1"></a><span class="ex">podman</span> exec <span class="at">-it</span> redis-semantic redis-cli ping</span>
<span id="cb6-18"><a href="#cb6-18" aria-hidden="true" tabindex="-1"></a><span class="ex">podman</span> exec <span class="at">-it</span> redis-semantic redis-cli SET test <span class="st">"hello"</span></span>
<span id="cb6-19"><a href="#cb6-19" aria-hidden="true" tabindex="-1"></a><span class="ex">podman</span> exec <span class="at">-it</span> redis-semantic redis-cli GET test</span>
<span id="cb6-20"><a href="#cb6-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-21"><a href="#cb6-21" aria-hidden="true" tabindex="-1"></a><span class="co"># Verificar que se solucionó</span></span>
<span id="cb6-22"><a href="#cb6-22" aria-hidden="true" tabindex="-1"></a><span class="co"># Ver logs (no debe haber errores de permisos)</span></span>
<span id="cb6-23"><a href="#cb6-23" aria-hidden="true" tabindex="-1"></a><span class="ex">podman</span> logs redis-semantic</span>
<span id="cb6-24"><a href="#cb6-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-25"><a href="#cb6-25" aria-hidden="true" tabindex="-1"></a><span class="co"># Probar escritura</span></span>
<span id="cb6-26"><a href="#cb6-26" aria-hidden="true" tabindex="-1"></a><span class="ex">podman</span> exec <span class="at">-it</span> redis-semantic redis-cli</span>
<span id="cb6-27"><a href="#cb6-27" aria-hidden="true" tabindex="-1"></a><span class="co"># Dentro de redis-cli:</span></span>
<span id="cb6-28"><a href="#cb6-28" aria-hidden="true" tabindex="-1"></a><span class="ex">SET</span> mykey <span class="st">"test value"</span></span>
<span id="cb6-29"><a href="#cb6-29" aria-hidden="true" tabindex="-1"></a><span class="ex">GET</span> mykey</span>
<span id="cb6-30"><a href="#cb6-30" aria-hidden="true" tabindex="-1"></a><span class="ex">BGSAVE</span>  <span class="co"># Forzar guardado en disco</span></span>
<span id="cb6-31"><a href="#cb6-31" aria-hidden="true" tabindex="-1"></a><span class="bu">exit</span></span>
<span id="cb6-32"><a href="#cb6-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-33"><a href="#cb6-33" aria-hidden="true" tabindex="-1"></a><span class="co"># Ver que no haya errores</span></span>
<span id="cb6-34"><a href="#cb6-34" aria-hidden="true" tabindex="-1"></a><span class="ex">podman</span> logs redis-semantic <span class="kw">|</span> <span class="fu">tail</span> <span class="at">-20</span></span>
<span id="cb6-35"><a href="#cb6-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-36"><a href="#cb6-36" aria-hidden="true" tabindex="-1"></a><span class="ex">podman</span> exec <span class="at">-it</span> redis-semantic redis-cli CONFIG GET save    </span>
<span id="cb6-37"><a href="#cb6-37" aria-hidden="true" tabindex="-1"></a><span class="co"># Debería arrojar esto :</span></span>
<span id="cb6-38"><a href="#cb6-38" aria-hidden="true" tabindex="-1"></a><span class="co"># 1) "save"</span></span>
<span id="cb6-39"><a href="#cb6-39" aria-hidden="true" tabindex="-1"></a><span class="co"># 2) ""</span></span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Configurar la instancia de <strong>Mongo local</strong> que almacena las fichas técnicas de los productos.</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 1. Crear y levantar el contenedor MongoDB</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="ex">podman</span> run <span class="at">-d</span> <span class="dt">\</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">--name</span> mongo-semantic <span class="dt">\</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">-p</span> 27017:27017 <span class="dt">\</span></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">-v</span> mongo-data:/data/db <span class="dt">\</span></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>  mongo:latest</span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a><span class="co"># 2. Verificar que el contenedor esté corriendo</span></span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a><span class="ex">podman</span> ps <span class="at">-a</span></span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a><span class="co"># 3. Copiar el archivo JSON de las fichas técnicas al contenedor</span></span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a><span class="ex">podman</span> cp ./datos/CT_API_Publica.tbl_mongo_collection_specifications.json mongo-semantic:/tmp/specs.json</span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a><span class="co"># 4. Importar el JSON (esto crea automáticamente la BD y la colección)</span></span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a><span class="ex">podman</span> exec <span class="at">-it</span> mongo-semantic mongoimport <span class="dt">\</span></span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true" tabindex="-1"></a>  <span class="at">--db</span> CT_API_Publica <span class="dt">\</span></span>
<span id="cb7-17"><a href="#cb7-17" aria-hidden="true" tabindex="-1"></a>  <span class="at">--collection</span> tbl_mongo_collection_specifications <span class="dt">\</span></span>
<span id="cb7-18"><a href="#cb7-18" aria-hidden="true" tabindex="-1"></a>  <span class="at">--file</span> /tmp/specs.json <span class="dt">\</span></span>
<span id="cb7-19"><a href="#cb7-19" aria-hidden="true" tabindex="-1"></a>  <span class="at">--jsonArray</span></span>
<span id="cb7-20"><a href="#cb7-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-21"><a href="#cb7-21" aria-hidden="true" tabindex="-1"></a><span class="co"># 5. Conectar a MongoDB para verificar</span></span>
<span id="cb7-22"><a href="#cb7-22" aria-hidden="true" tabindex="-1"></a><span class="ex">podman</span> exec <span class="at">-it</span> mongo-semantic mongosh</span>
<span id="cb7-23"><a href="#cb7-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-24"><a href="#cb7-24" aria-hidden="true" tabindex="-1"></a><span class="co"># 6. Dentro de mongosh, verificar los datos:</span></span>
<span id="cb7-25"><a href="#cb7-25" aria-hidden="true" tabindex="-1"></a><span class="ex">use</span> CT_API_Publica          <span class="co"># Cambiar a la base de datos correcta</span></span>
<span id="cb7-26"><a href="#cb7-26" aria-hidden="true" tabindex="-1"></a><span class="ex">show</span> collections            <span class="co"># Ver las colecciones (debe aparecer tbl_mongo_collection_specifications)</span></span>
<span id="cb7-27"><a href="#cb7-27" aria-hidden="true" tabindex="-1"></a><span class="fu">db.tbl_mongo_collection_specifications.countDocuments()</span>  <span class="co"># Contar documentos</span></span>
<span id="cb7-28"><a href="#cb7-28" aria-hidden="true" tabindex="-1"></a><span class="fu">db.tbl_mongo_collection_specifications.findOne()</span>         <span class="co"># Ver un documento de ejemplo</span></span>
<span id="cb7-29"><a href="#cb7-29" aria-hidden="true" tabindex="-1"></a><span class="bu">exit</span>                        <span class="co"># Salir de mongosh</span></span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="configurar-variables-de-entorno" class="level4">
<h4 class="anchored" data-anchor-id="configurar-variables-de-entorno">1.4.4. Configurar variables de entorno</h4>
<p>Antes de levantar el <em>backend</em>, asegurarse de que el archivo <code>.env</code> en la raíz del proyecto contenga las siguientes variables con sus valores correctos.</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Conexión a la base de datos SQL</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>ip<span class="op">=</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>port<span class="op">=</span></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>user<span class="op">=</span></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>pwd<span class="op">=</span></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>db<span class="op">=</span></span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Clave de la API de OpenAI para correr sus modelos</span></span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a>OPENAI_API_KEY<span class="op">=</span></span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Configuración para el servicio de fichas técnicas</span></span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a>sucursales_url <span class="op">=</span> <span class="st">""</span>  <span class="co"># Url de la sección de sucursales</span></span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a>reload_vectors_post <span class="op">=</span> <span class="st">"https://localhost:8000/internal/reload_vectorstores"</span></span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a>url<span class="op">=</span> <span class="st">''</span>           <span class="co"># Url del servicio de fichas tecnicas</span></span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a>Token<span class="op">-</span>api<span class="op">=</span><span class="st">''</span></span>
<span id="cb8-16"><a href="#cb8-16" aria-hidden="true" tabindex="-1"></a>Token<span class="op">-</span>ct<span class="op">=</span><span class="st">''</span></span>
<span id="cb8-17"><a href="#cb8-17" aria-hidden="true" tabindex="-1"></a>Content<span class="op">-</span>Type<span class="op">=</span><span class="st">''</span></span>
<span id="cb8-18"><a href="#cb8-18" aria-hidden="true" tabindex="-1"></a>Cookie<span class="op">=</span><span class="st">''</span></span>
<span id="cb8-19"><a href="#cb8-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-20"><a href="#cb8-20" aria-hidden="true" tabindex="-1"></a>sucursales_url<span class="op">=</span> <span class="st">""</span></span>
<span id="cb8-21"><a href="#cb8-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-22"><a href="#cb8-22" aria-hidden="true" tabindex="-1"></a>dominio<span class="op">=</span><span class="st">""</span></span>
<span id="cb8-23"><a href="#cb8-23" aria-hidden="true" tabindex="-1"></a>boundary<span class="op">=</span><span class="st">''</span></span>
<span id="cb8-24"><a href="#cb8-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-25"><a href="#cb8-25" aria-hidden="true" tabindex="-1"></a><span class="co"># Conexión a MongoDB</span></span>
<span id="cb8-26"><a href="#cb8-26" aria-hidden="true" tabindex="-1"></a>MONGO_URI <span class="op">=</span> <span class="st">"mongodb://"</span> <span class="co"># En la URI debe estar incrustrado el nombre de la DB</span></span>
<span id="cb8-27"><a href="#cb8-27" aria-hidden="true" tabindex="-1"></a>MONGO_DB <span class="op">=</span> <span class="st">""</span></span>
<span id="cb8-28"><a href="#cb8-28" aria-hidden="true" tabindex="-1"></a>MONGO_COLLECTION_SESSIONS <span class="op">=</span> <span class="st">"tbl_sessions"</span></span>
<span id="cb8-29"><a href="#cb8-29" aria-hidden="true" tabindex="-1"></a>MONGO_COLLECTION_MESSAGE_BACKUP <span class="op">=</span> <span class="st">"tbl_message_backup"</span></span>
<span id="cb8-30"><a href="#cb8-30" aria-hidden="true" tabindex="-1"></a>MONGO_COLLECTION_PRODUCTS <span class="op">=</span> <span class="st">"tbl_productos"</span></span>
<span id="cb8-31"><a href="#cb8-31" aria-hidden="true" tabindex="-1"></a>MONGO_COLLECTION_SALES <span class="op">=</span> <span class="st">"tbl_ofertas"</span>         </span>
<span id="cb8-32"><a href="#cb8-32" aria-hidden="true" tabindex="-1"></a>MONGO_COLLECTION_SPECIFICATIONS <span class="op">=</span> <span class="st">"tbl_mongo_collection_specifications"</span></span>
<span id="cb8-33"><a href="#cb8-33" aria-hidden="true" tabindex="-1"></a>MONGO_COLLECTION_PEDIDOS<span class="op">=</span><span class="st">"tbl_pedidos"</span></span>
<span id="cb8-34"><a href="#cb8-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-35"><a href="#cb8-35" aria-hidden="true" tabindex="-1"></a>PODMAN_REDIS_URL<span class="op">=</span>redis:<span class="op">//</span>localhost:<span class="dv">6379</span></span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="levantar-el-backend-con-gunicorn" class="level4">
<h4 class="anchored" data-anchor-id="levantar-el-backend-con-gunicorn">1.4.5. Levantar el backend con Gunicorn</h4>
<p>Este comando inicia la API, especificando el número de <em>workers</em>, el <em>binding</em> de IP y puerto, y la configuración de SSL/TLS para HTTPS.</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="fu">nohup</span> gunicorn ct.main:app   <span class="at">--workers</span> 4   <span class="at">--bind</span> 0.0.0.0:8000   <span class="at">--certfile</span><span class="op">=</span>static/ssl/cert.pem   <span class="at">--keyfile</span><span class="op">=</span>static/ssl/key.pem   <span class="at">-k</span> uvicorn.workers.UvicornWorker <span class="at">--timeout</span> 120 <span class="at">--access-logfile</span> <span class="at">-</span>   <span class="at">--error-logfile</span> <span class="at">-</span> <span class="kw">&amp;</span></span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>El uso de <code>nogup</code> y <code>&amp;</code> asegura que el proceso continúe ejecutándose en segundo plano incluso si la sesión SSH se cierra.</p>
</section>
<section id="regenerar-el-certificado-ssl-si-expira-o-es-necesario" class="level4">
<h4 class="anchored" data-anchor-id="regenerar-el-certificado-ssl-si-expira-o-es-necesario">1.4.6. Regenerar el certificado SSL (si expira o es necesario)</h4>
<p>Si el certificado SSL autofirmado ha expirado o necesitas uno nuevo:</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="ex">openssl</span> req <span class="at">-x509</span> <span class="at">-newkey</span> rsa:2048 <span class="at">-nodes</span> <span class="at">-keyout</span> ssl/key.pem <span class="at">-out</span> ssl/cert.pem&nbsp;-days&nbsp;365</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Asegurarse de que los archivos <code>cert.pem</code> y <code>key.pem</code> estén en la ruta <code>ssl</code> dentro de tu proyecto.</p>
</section>
<section id="verificar-logs" class="level4">
<h4 class="anchored" data-anchor-id="verificar-logs">1.4.7. Verificar logs</h4>
<p>Al correr la API con <code>nohup</code>, este genera un archivo <code>nohup.out</code>, con el cual podemos ver los logs del sistema, para eso solo hay que ubicarse en donde está dicho archivo y correr lo siguiente:</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="fu">tail</span> <span class="at">-f</span> nohup.out</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Los logs también se pueden analizar para el reporte automatizado</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="fu">nohup</span> streamlit run run_report.py <span class="at">--server.fileWatcherType</span> none <span class="at">--server.port</span> 3000 <span class="kw">&amp;</span></span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
</section>
<section id="instalación-del-frontend-widget" class="level3">
<h3 class="anchored" data-anchor-id="instalación-del-frontend-widget">1.5 Instalación del frontend (Widget)</h3>
<ol type="1">
<li><p><strong>Cargar archivos del widget</strong>: Los archivos del <em>frontend</em> (principalmente <code>sdk.js</code> y cualquier recurso gráfico como <code>chat.png</code>) deben ser cargados en el servidor donde reside el <em>frontend</em> de la página.</p></li>
<li><p><strong>Incrustar el widget en el HTML</strong>: Ejemplo de cómo se puede añadir el widget en la página web donde se desea que aparezca el chatbot.</p></li>
</ol>
<div class="sourceCode" id="cb13"><pre class="sourceCode html code-with-copy"><code class="sourceCode html"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;!DOCTYPE</span> html<span class="dt">&gt;</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;</span><span class="kw">html</span><span class="ot"> lang</span><span class="op">=</span><span class="st">"es"</span><span class="dt">&gt;</span></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;</span><span class="kw">head</span><span class="dt">&gt;</span></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&lt;</span><span class="kw">meta</span><span class="ot"> charset</span><span class="op">=</span><span class="st">"UTF-8"</span><span class="ot"> </span><span class="dt">/&gt;</span></span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&lt;</span><span class="kw">title</span><span class="dt">&gt;</span>Prueba del Widget<span class="dt">&lt;/</span><span class="kw">title</span><span class="dt">&gt;</span></span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;/</span><span class="kw">head</span><span class="dt">&gt;</span></span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;</span><span class="kw">body</span><span class="dt">&gt;</span></span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&lt;</span><span class="kw">script</span><span class="ot"> </span></span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a><span class="ot">    src</span><span class="op">=</span><span class="st">"sdk.js"</span><span class="ot"> </span></span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a><span class="ot">    data-user-id</span><span class="op">=</span><span class="st">"test"</span><span class="ot"> </span></span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a><span class="ot">    data-user-key</span><span class="op">=</span><span class="st">"2"</span><span class="ot"> </span></span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a><span class="ot">    data-api-base</span><span class="op">=</span><span class="st">"https://ctdev.ctonline.mx/chatbot"</span><span class="ot"> </span></span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a><span class="ot">    data-chat-icon-url</span><span class="op">=</span><span class="st">"chat.png"</span><span class="ot"> </span></span>
<span id="cb13-14"><a href="#cb13-14" aria-hidden="true" tabindex="-1"></a><span class="ot">    type=</span><span class="st">"text/javascript"</span><span class="dt">&gt;</span></span>
<span id="cb13-15"><a href="#cb13-15" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&lt;/</span><span class="kw">script</span><span class="dt">&gt;</span></span>
<span id="cb13-16"><a href="#cb13-16" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;/</span><span class="kw">body</span><span class="dt">&gt;</span></span>
<span id="cb13-17"><a href="#cb13-17" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;/</span><span class="kw">html</span><span class="dt">&gt;</span></span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><strong>Notas importantes para el <code>data-api-base</code>:</strong></p>
<ul>
<li>Si la API corre en HTTP y el <em>frontend</em> en HTTPS, se enfrentarán problemas de “contenido mixto”. La solución propuesta fue usar un archivo PHP (<em>backend</em> del sitio web) como intermediario, el cual es crucial aquí. La API debe apuntar a este PHP y el PHP a su <em>frontend</em> donde se encuentra el widget.</li>
<li>La <code>data-api-base</code> es el dominio donde es accesible la API mediante PHP.</li>
</ul>
</section>
<section id="actualización-de-la-base-de-conocimientos-etl" class="level3">
<h3 class="anchored" data-anchor-id="actualización-de-la-base-de-conocimientos-etl">1.6 Actualización de la base de conocimientos (ETL)</h3>
<p>Para asegurar que el chatbot tenga acceso a la información más reciente de productos, promociones y fichas técnicas, es necesario ejecutar periódicamente el pipeline ETL. Este proceso extrae, transforma y carga los datos, actualizando la base de datos vectorial utilizada por el sistema RAG.</p>
<p>Para ejecutar el pipeline ETL, sigue estos pasos:</p>
<ol type="1">
<li><strong>Acceder al entorno virtual</strong>: Asegurarse de estar en el directorio raíz del proyecto (<code>proyectoCT</code>) y activa el entorno virtual donde se instalaron las dependencias del <em>backend</em>.</li>
</ol>
<div class="sourceCode" id="cb14"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="bu">source</span> .venv/bin/activate <span class="co"># Para Linux/macOS</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a><span class="co"># o `.venv/Scripts/activate` para Windows</span></span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ol start="2" type="1">
<li><strong>Ejecutar el pipeline ETL</strong>: Una vez activado el entorno, puedes ejecutar una de las funciones dentro del script <code>pipeline.py</code> dependiendo la necesidad.</li>
</ol>
<p>En caso de cargar la base general de productos, correr este comando. Recomendación, correr cada 2 o 3 meses, ya que la información técnica cambia con poca frecuencia.</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="ex">python3</span> <span class="at">-c</span> <span class="st">"from ct.ETL.pipeline import load_products; load_products()"</span></span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Consejo: si ya se tiene una base de datos vectorial de productos, agregar productos nuevos con el siguiente comando. Esto evita tener que extraer, transformar y cargar todos los productos, simplemente va agregando los faltantes.</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="ex">python3</span> <span class="at">-c</span> <span class="st">"from ct.ETL.pipeline import update_products; update_products()"</span></span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>En caso de cargar únicamente los productos en promoción, correr este comando. Eficiente para cada mes que hay productos nuevos en promoción.</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="ex">python3</span> <span class="at">-c</span> <span class="st">"from ct.ETL.pipeline import load_sales; load_sales()"</span></span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Una vez que ya se tienen las dos bases vectoriales, es necesario combinarlos y cargarlos.</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="ex">python3</span> <span class="at">-c</span> <span class="st">"from ct.ETL.pipeline import load_sales_products; load_sales_products()"</span></span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>En caso de querer actualizar ambas al mismo tiempo, correr este comando. Esto elimina productos antiguos que sean innecesarios almacenar.</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="ex">python3</span> <span class="at">-c</span> <span class="st">"from ct.ETL.pipeline import update_all; update_all()"</span></span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ol start="3" type="1">
<li><strong>Crontab del ETL (opcional)</strong>: Se recomienda automatizar la ejecución de este pipeline (por ejemplo, <strong>cada hora entre las 8:30 a 18:30</strong>) para mantener actualizada la base de conocimientos del chatbot.</li>
</ol>
<p>En sistemas <strong>Linux</strong>, esto se puede realizar fácilmente mediante un <strong>cron job</strong>.</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Dar permisos de ejecución al archivo bash</span></span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a><span class="fu">chmod</span> +x ~/proyectoCT/reload_all.sh</span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Agregar la tarea al cron</span></span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a><span class="fu">crontab</span> <span class="at">-e</span></span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Añade la siguiente línea</span></span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a><span class="ex">30</span> 8-18 <span class="pp">*</span> <span class="pp">*</span> <span class="pp">*</span> ~/proyectoCT/reload_all.sh <span class="kw">&amp;&amp;</span> <span class="ex">pkill</span> <span class="at">-HUP</span> gunicorn <span class="op">&gt;&gt;</span> ~/proyectoCT/logs/reload_cron_wrapper.log <span class="dv">2</span><span class="op">&gt;&amp;</span><span class="dv">1</span></span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-10"><a href="#cb20-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Verificar que se hizo correctamente con</span></span>
<span id="cb20-11"><a href="#cb20-11" aria-hidden="true" tabindex="-1"></a><span class="fu">crontab</span> <span class="at">-l</span></span>
<span id="cb20-12"><a href="#cb20-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-13"><a href="#cb20-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Cuando ya se haya ejecutado el flujo del cron, se puede revisar con</span></span>
<span id="cb20-14"><a href="#cb20-14" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span> ~/proyectoCT/logs/reload_cron_wrapper.log</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Comandos útiles de <code>cron</code></p>
<table class="caption-top table">
<thead>
<tr class="header">
<th>Acción</th>
<th>Comando</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Ver tareas activas</td>
<td><code>crontab -l</code></td>
</tr>
<tr class="even">
<td>Borrar todas las tareas</td>
<td><code>crontab -r</code></td>
</tr>
<tr class="odd">
<td>Pausar una tarea</td>
<td>Editar y comentar la línea con <code>#</code></td>
</tr>
</tbody>
</table>
<p>Cómo salir del editor</p>
<ul>
<li><strong>En <code>nano</code></strong> -&gt; <code>Ctrl + O</code>, <code>Enter</code>, luego <code>Ctrl + X</code></li>
<li><strong>En <code>vi</code> o <code>vim</code></strong> -&gt; <code>I</code>, editar, <code>Esc</code>, luego <code>:wq</code> para guardar o <code>:q!</code> para salir sin guardar</li>
</ul>
</section>
<section id="descargas-y-configuraciones-adicionales" class="level3">
<h3 class="anchored" data-anchor-id="descargas-y-configuraciones-adicionales">1.7 Descargas y configuraciones adicionales</h3>
<p>Estas configuraciones son necesarios para que no haya problemas dentro del sistema de conversaciones y el sistema de reportes automatizados.</p>
<div class="sourceCode" id="cb21"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="ex">python</span> <span class="at">-m</span> spacy download es_core_news_lg</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a><span class="ex">python</span> <span class="at">-m</span> spacy download es_core_news_sm</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="notas-adicionales" class="level3">
<h3 class="anchored" data-anchor-id="notas-adicionales">1.8 Notas adicionales</h3>
<ul>
<li><strong>Problemas de caché</strong>: Es común que los navegadores almacenen versiones antiguas de archivos JS/CSS. Si la interfaz del <em>widget</em> no funciona correctamente después de una actualización, instruye a los usuarios a limpiar la caché de su navegador o a realizar un “hard refresh” (Ctrl+F5). Implementar una estrategia de <em>versioning</em> para los archivos del <em>widget</em> (ej.js?v=1.2.3) puede mitigar esto a futuro.</li>
<li><strong>Rotación de IP para fichas técnicas</strong>: El sistema está diseñado para manejar el bloqueo de IP del servicio de fichas técnicas. Se recomienda monitorear los logs de la extracción (<code>extraction.py</code>) para identificar errores 403, lo que indicaría la necesidad de actualizar la IP en el servicio externo.</li>
</ul>
</section>
</section>
<section id="documentación-técnica-del-código" class="level2" style="text-align: justify">
<h2 class="anchored" data-anchor-id="documentación-técnica-del-código">2 Documentación técnica del código</h2>
<section id="estructura-de-carpetas-y-módulos" class="level3">
<h3 class="anchored" data-anchor-id="estructura-de-carpetas-y-módulos">2.1 Estructura de carpetas y módulos</h3>
<p>El proyecto sigue una estructura modular para facilitar la gestión y el mantenimiento. A continuación, se detalla el propósito de los módulos principales y algunas de sus funciones clave:</p>
<p><strong>ct/langchain/vectorstore.py</strong></p>
<p>Este módulo implementa la lógica para la creación, carga y consulta de la base de datos vectorial FAISS. Gestiona el retriever que busca los documentos más relevantes.</p>
<ul>
<li><strong>Clases y funciones clave</strong>:
<ul>
<li><code>class LangchainVectorStore</code>:
<ul>
<li><code>__init__(self, embedder, index_path: str = None)</code>: Inicializa el <em>vector store</em>.
<ul>
<li><strong>Propósito</strong>: Inicializa el <em>vector store</em> de Langchain, configurando el <em>embedder</em> y la ruta del índice. Si el índice ya existe, lo carga; de lo contrario, se preparará para crear uno nuevo.</li>
<li><strong>Parámetros</strong>:
<ul>
<li><code>embedder</code>: Una instancia de la clase <em>embedder</em> utilizada para generar los <em>embeddings</em> (ej., <code>OpenAIEmbeddings(openai_api_key=openai_api_key)</code>).</li>
<li><code>index_path</code> (<code>str</code>): Ruta al directorio donde se guardará o cargará en el índice FAISS.</li>
</ul></li>
<li><strong>Comportarmiento</strong>:
<ul>
<li>Almacena el <code>embedder</code> y el <code>index_path</code>.</li>
<li>Si <code>index_path</code> existe y es un directorio válido, llama a <code>_load_index()</code> para cargar el índice preexistente.</li>
<li>Inicializa <code>self.vectorstore</code> as <code>None</code> hasta que se cargue o cree.</li>
</ul></li>
</ul></li>
<li><code>_load_index(self)</code>:
<ul>
<li><strong>Propósito</strong>: Carga un índice FAISS existente desde disco en <code>self.vectorstore</code>.</li>
<li><strong>Parámetros</strong>: Ninguno (usa <code>self.index_path</code>).</li>
<li><strong>Comportamiento</strong>:
<ul>
<li>Utiliza <code>FAISS.load_local()</code> para cargar el índice desde la <code>folder_path</code> especificada en <code>self.index_path</code>, usando el <code>embedder</code> configurado.</li>
<li><code>allow_dangerous_deserialization=True</code> se usa para permitir la carga de índices serializados.</li>
<li>Es una función interna que no debe ser llamada directamente desde fuera de la clase.</li>
</ul></li>
</ul></li>
</ul></li>
</ul></li>
</ul>
<p><strong>ct/langchain/tool_agent.py</strong></p>
<p>Este archivo contiene la lógica principal del agente conversacional, incluyendo la interacción con herramientas externas, gestión del historial de conversación, uso de MongoDB, y conexión con el modelo GPT-4.1 a través de LangChain y OpenAI.</p>
<ul>
<li><strong>Clases y funciones clave</strong>:
<ul>
<li><code>class ToolAgent</code>:
<ul>
<li><code>__init__</code>:
<ul>
<li><strong>Propósito</strong>: Inicializa el agente, configurando el modelo LLM, conectando a MongoDB para la persistencia de sesiones e historial, definiendo el <em>prompt</em> principal del sistema y registrando las herramientas disponibles.</li>
<li><strong>Comportamiento</strong>:
<ul>
<li>Establece <code>self.model</code> a “gpt-4.1”.</li>
<li>Inicializa las conexiones a las colecciones de MongoDB (<code>sessions</code>, <code>message_backup</code>).</li>
<li>Define <code>self.prompt</code> como un <code>ChatPromptTemplate</code> que guía el comportamiento del agente, incluyendo instrucciones de formato de respuesta y el manejo del historial (<code>chat_history</code>).</li>
<li>Define <code>self.tools</code> como una lista de objetos <code>Tool</code> y <code>StructuredTool</code>, que el agente puede invocar. Estas herramientas incluyen <code>search_information_tool</code>, <code>inventory_tool</code> y <code>sales_rules_tool</code>, cada una con su descripción y esquema de argumentos (<code>args_schema</code>) cuando aplica.</li>
<li><code>self.executor</code> se inicializa a <code>None</code> y se construye bajo demanda.</li>
</ul></li>
</ul></li>
<li><code>clear_session_history(self, session_id: str) -&gt; bool</code>:
<ul>
<li><strong>Propósito</strong>: Limpia el historial de mensajes (<code>last_messages</code>) para una sesión de usuario específica en la base de datos de MongoDB. Limpia el historial de mensajes para una sesión en particular.</li>
<li><strong>Parámetros</strong>:
<ul>
<li><code>session_id (str)</code>: El identificador único de la sesión cuyo historial se desea borrar.</li>
</ul></li>
<li><strong>Retorna</strong>: <code>bool</code>: <code>True</code> si la operación fue exitosa, <code>False</code> en caso de error.</li>
<li><strong>Comportamiento</strong>: Actualiza el documento de la sesión en MongoDB, estableciendo <code>last_messages</code> como una lista vacía. Maneja excepciones de PyMongo y otras.</li>
</ul></li>
<li><code>ensure_session(self, session: str) -&gt; dict</code>:
<ul>
<li><strong>Propósito</strong>: Garantiza que exista una entrada para la <code>sesion_id</code> en la colección <code>sessions</code> de MongoDB. Si no existe, la crea; si existe, actualiza la marca de tiempo de la última actividad.</li>
<li><strong>Parámetros</strong>:
<ul>
<li><code>session_id (str)</code>: El identificador de la sesión.</li>
</ul></li>
<li><strong>Retorna</strong>: <code>dict</code>: El documento de la sesión actualizado o recién creado.</li>
<li><strong>Comportamiento</strong>: Utiliza <code>update_one</code> con <code>$setOnInsert</code> y <code>$set</code> para manejar la lógica de upsert y actualización de actividad.</li>
</ul></li>
<li><code>build_executor(self)</code>:
<ul>
<li><strong>Propósito</strong>: Construye el <code>AgentExecutor</code> de LangChain, que es el componente principal que orquesta la interacción entre el LLM, las herramientas y el <em>prompt</em>.</li>
<li><strong>Parámetros</strong>: Ninguno (usa atributos de la clase).</li>
<li><strong>Comportamiento</strong>:
<ul>
<li>Crea un <code>ChatOpenAI</code> LLM con el modelo y la configuración de <em>streaming</em>.</li>
<li>Crea un agente de funciones de OpenAI (<code>create_openai_functions_agent</code>) vinculando el LLM, las herramientas y el <em>prompt</em>.</li>
<li>Inicializa <code>self.executor</code> como una instancia de <code>AgentExecutor</code>, configurándolo para ser <code>verbose=False</code> y con un <code>max_iterations</code> para controlar la profundidad de la ejecución del agente.</li>
</ul></li>
</ul></li>
<li><code>run</code>:</li>
</ul>
<div class="sourceCode" id="cb22"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="cf">async</span> <span class="kw">def</span> run(</span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a> session_id: <span class="bu">str</span>, </span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a> question: <span class="bu">str</span>, </span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a> listaPrecio: <span class="bu">str</span> <span class="op">=</span> <span class="va">None</span></span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a> ) <span class="op">-&gt;</span> AsyncGenerator[<span class="bu">str</span>, <span class="va">None</span>]: </span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ul>
<li><strong>Propósito</strong>: Ejecuta una consulta del usuario a través del agente, gestiona el historial de chat, recopila métricas y transmite la respuesta en tiempo real.</li>
<li><strong>Parámetros</strong>:
<ul>
<li><code>session_id (str)</code>: ID de la sesión del usuario.</li>
<li><code>question (str)</code>: La pregunta del usuario.</li>
<li><code>listaPrecio (str)</code>: El nivel de lista de precios asociado al usuario, usado en el <em>prompt</em> del LLM.</li>
</ul></li>
<li><strong>Retorna</strong>: <code>AsyncGenerator[str, None]</code>: Un generador asíncrono que cede fragmentos (<code>chunks</code>) de la respuesta a medida que se generan.</li>
<li><strong>Comportamiento</strong>:
<ul>
<li>Recupera el historial completo de la sesión (<code>get_session_history</code>).</li>
<li>Trunca el historial (<code>trim_messages</code>) para ajustarse a la ventana de contexto del LLM, priorizando los mensajes más recientes.</li>
<li>Inicializa un <code>TokenCostProcess</code> y <code>CostCalcAsyncHandler</code> para el seguimiento de tokens y costos.</li>
<li>Si el <code>executor</code> no está construido, llama a <code>build_executor()</code>.</li>
<li>Define los <code>inputs</code> para el <code>executor</code>, incluyendo la <code>query</code>, <code>chat_history</code>, <code>listaPrecio</code> y <code>session_id</code>.</li>
<li>Utiliza <code>self.executor.astream()</code> para obtener la respuesta en <em>streaming</em>.</li>
<li>Acumula los fragmentos de la respuesta completa.</li>
<li>En el bloque <code>finally</code>, calcula la duración y los metadatos de la interacción.</li>
<li>Persiste los mensajes del usuario y del asistente en las colecciones <code>sessions</code> y <code>message_backup</code> de MongoDB.</li>
</ul></li>
<li><code>get_session_history(self, session_id: str) -&gt; list[BaseMessage]</code>:
<ul>
<li><strong>Propósito</strong>: Recupera el historial de mensajes de una sesión específica desde MongoDB y lo convierte a objetos <code>BaseMessage</code> de LangChain.</li>
<li><strong>Parámetros</strong>:
<ul>
<li><code>session_id (str)</code>: El ID del usuario cuyo historial se desea recuperar.</li>
</ul></li>
<li><strong>Retorna</strong>: <code>list[baseMessage]</code>: Una lista de objetos <code>HumanMessage</code> y <code>AIMessage</code> que representan el historial de conversación.</li>
<li><strong>Comportamiento</strong>: Consulta la colección <code>sessions</code> en MongoDB para el <code>session_id</code> dado y mapea los mensajes almacenados a los tipos de mensaje de LangChain.</li>
</ul></li>
<li><code>add_message</code></li>
</ul>
<div class="sourceCode" id="cb23"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> add_message(</span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a> session_id: <span class="bu">str</span>, </span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a> message_type: <span class="bu">str</span>, </span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a> content: <span class="bu">str</span>, </span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a> metadata: <span class="bu">dict</span> <span class="op">=</span> <span class="va">None</span>): </span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ul>
<li><strong>Propósito</strong>: Añade un nuevo mensaje (de usuario o asistente) al historial de <code>last_messages</code> de una sesión en MongoDB, manteniendo un tamaño fijo para optimizar el rendimiento.</li>
<li><strong>Parámetros</strong>:
<ul>
<li><code>session_id (str)</code>: ID de la sesión.</li>
<li><code>message_type (str)</code>: Tipo de mensaje, puede ser “human” o “assistant”.</li>
<li><code>content (str)</code>: Contenido textual del mensaje.</li>
</ul></li>
<li><strong>Comportamiento</strong>:
<ul>
<li>Crea un diccionario <code>short_msg</code> con el tipo, contenido y timestamp.</li>
<li>Utiliza <code>$push</code> con <code>$each</code>, <code>$sort</code> y <code>$slice</code> para añadir el nuevo mensaje y truncar la lista <code>last_messages</code> a los últimos 24 mensajes (configurable).</li>
</ul></li>
<li><code>add_message_backup</code></li>
</ul>
<div class="sourceCode" id="cb24"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> add_message_backup(</span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a> session_id: <span class="bu">str</span>, </span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a> question: <span class="bu">str</span>, </span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a> full_answer: <span class="bu">str</span>, </span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a> metadata: <span class="bu">dict</span> <span class="op">=</span> <span class="va">None</span>): </span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ul>
<li><p><strong>Propósito</strong>: Guarda un respaldo completo de cada interacción (pregunta del usuario y respuesta completa del asistente) junto con métricas detalladas en la colección <code>message_backup</code> de MongoDB para análisis posterior.</p></li>
<li><p><strong>Parámetros</strong>:</p>
<ul>
<li><code>session_id (str)</code>: ID de la sesión.</li>
<li><code>question (str)</code>: La pregunta original del usuario.</li>
<li><code>full_answer (str)</code>: La respuesta completa generada por el asistente.</li>
<li><code>metadata (dict)</code>: Diccionario con metadatos adicionales (tokens, costo, duración, modelo utilizado).</li>
</ul></li>
<li><p><strong>Comportamiento</strong>: Inserta un nuevo documento en <code>message_backup</code> con toda la información relevante para análisis posterior.</p></li>
<li><p><code>add_irrelevant_message</code></p></li>
</ul>
<div class="sourceCode" id="cb25"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> add_irrelevant_message(</span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a> <span class="va">self</span>,</span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a> session_id: <span class="bu">str</span>, </span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a> question: <span class="bu">str</span>, </span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a> full_answer: <span class="bu">str</span>, </span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a> metadata: <span class="bu">dict</span> <span class="op">=</span> <span class="va">None</span>): </span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ul>
<li><p><strong>Propósito</strong>: Guarda un mensaje etiquetado como “irrelevante” en la colección <code>message_backup</code>. Esto es útil para el monitoreo y posible re-entrenamiento del clasificador.</p></li>
<li><p><strong>Parámetros</strong>:</p>
<ul>
<li><code>session_id (str)</code>: ID de la sesión.</li>
<li><code>question (str)</code>: La pregunta del usuario clasificada como irrelevante.</li>
<li><code>full_answer (str)</code>: La respuesta generada por el moderador para consultas irrelevantes.</li>
</ul></li>
<li><p><strong>Comportamiento</strong>: Inserta un nuevo documento en <code>message_backup</code> con el campo <code>label</code> establecido en <code>False</code>.</p></li>
<li><p><code>make_metadata</code></p></li>
</ul>
<div class="sourceCode" id="cb26"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> make_metadata(</span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a> <span class="va">self</span>,</span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a> token_cost_process: TokenCostProcess,</span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a> duration: <span class="bu">float</span> <span class="op">=</span> <span class="va">None</span>) <span class="op">-&gt;</span> <span class="bu">dict</span> : </span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ul>
<li><strong>Propósito</strong>: Genera un diccionario con metadatos de la interacción, incluyendo información sobre el costo, los tokens utilizados y el tiempo de procesamiento.</li>
<li><strong>Parámetros</strong>:
<ul>
<li><code>token_cost_process (TokenCostProcess)</code>: Objeto que contiene información de los tokens.</li>
<li><code>duration (float)</code>: Duración de la ejecución en segundos.</li>
</ul></li>
<li><strong>Retorna</strong>: <code>dict</code>: Diccionario con metadatos.</li>
</ul></li>
</ul></li>
</ul>
<p><strong>ct/tools/search_information.py</strong></p>
<p>Este módulo define la herramienta <code>search_information_tool</code>, que permite al chatbot realizar búsquedas semánticas en las bases de datos vectoriales de productos y promociones para encontrar elementos relevantes.</p>
<ul>
<li><strong>Clases y funciones clave</strong>:
<ul>
<li><code>vectorstore</code>:
<ul>
<li><strong>Propósito</strong>: Una instancia global de <code>LangchainVectorStore</code> que carga el vector store combinado de productos y promociones desde <code>SALES_PRODUCTS_VECTOR_PATH</code>.</li>
</ul></li>
<li><code>retriever_productos</code>:
<ul>
<li><strong>Propósito</strong>: Un <code>retriever</code> configurado para buscar similitudes en el vector store, filtrando específicamente por documentos de la colección “productos”.</li>
<li><strong>Configuración</strong>: <code>search_type='similarity'</code>, <code>k=2</code> (devuelve los 2 resultados más similares), <code>score_threshold=0.95</code> (filtra resultados con baja similitud), <code>filter={"collection": "productos"}</code>.</li>
</ul></li>
<li><code>retriever_promociones</code>:
<ul>
<li><strong>Propósito</strong>: Un <code>retriever</code> configurado de manera similar, pero filtrando por documentos de la colección “promociones”.</li>
<li><strong>Configuración</strong>: <code>search_type='similarity'</code>, <code>k=2</code> (devuelve los 2 resultados más similares), <code>score_threshold=0.95</code> (filtra resultados con baja similitud), <code>filter={"collection": "promociones"}</code>.</li>
</ul></li>
<li><code>parse_page_content (content)</code>:
<ul>
<li><strong>Propósito</strong>: Una función auxiliar interna que parsea el <code>page_content</code> de un documento de LangChain (que es una cadena de texto concatenada) de nuevo a un diccionario de clave-valor.</li>
<li><strong>Parámetros</strong>:
<ul>
<li><code>content (str)</code>: La cadena de texto del <code>page_content</code> del documento.</li>
</ul></li>
<li><strong>Retorna</strong>: <code>dict</code>: Un diccionario con las características del producto/promoción.</li>
<li><strong>Comportamiento</strong>: Utiliza expresiones regulares para dividir la cadena por <code>.</code> y luego por <code>:</code> para extraer las claves y valores.</li>
</ul></li>
<li><code>search_information_tool(query) -&gt; dict</code>:
<ul>
<li><strong>Propósito</strong>: Busca productos y promociones relevantes en las bases de datos vectoriales utilizando la búsqueda semántica.</li>
<li><strong>Parámetros</strong>:
<ul>
<li><code>query (str)</code>: La consulta de búsqueda del usuario.</li>
</ul></li>
<li><strong>Retorna</strong>: <code>dict</code>: Un diccionario que contiene dos listas: <code>"Promociones"</code> y <code>"Productos"</code>, donde cada lista contiene diccionarios de los resultados encontrados.</li>
<li><strong>Comportamiento</strong>:
<ul>
<li>Invoca <code>retriever_promociones.invoke(query)</code> y <code>retriever_productos.invoke(query)</code> para obtener los documentos más relevantes de cada colección.</li>
<li>Utiliza <code>parse_page_content()</code> para transformar el <code>page_content</code> de cada documento recuperado en un formato de diccionario estructurado.</li>
</ul></li>
</ul></li>
</ul></li>
</ul>
<p><strong>ct/tools/inventory.py</strong></p>
<p>Este módulo define la herramienta <code>inventory_tool</code>, que permite al chatbot consultar la disponibilidad, precio y moneda de un producto específico en la base de datos MySQL.</p>
<ul>
<li><strong>Clases y funciones clave</strong>:
<ul>
<li><code>class InventoryInput(BaseModel)</code>:
<ul>
<li><strong>Propósito</strong>: Define el esquema de entrada (parámetros) para la herramienta <code>inventory_tool</code> utilizando Pydantic, asegurando la validación de los datos.</li>
<li><strong>Atributos</strong>:
<ul>
<li><code>clave (str)</code>: La clave única del producto a consultar.</li>
<li><code>listaPrecio (int)</code>: El ID de la lista de precios a considerar para la consulta.</li>
</ul></li>
</ul></li>
<li><code>inventory_tool(clave: str, listaPrecio: int) -&gt; str</code>:
<ul>
<li><strong>Propósito</strong>: Define el esquema de entrada (parámetros) para la herramienta <code>inventory_tool</code> utilizando Pydantic, asegurando la validación de los datos.</li>
<li><strong>Atributos</strong>:
<ul>
<li><code>clave (str)</code>: La clave del producto.</li>
<li><code>listaPrecio (int)</code>: El ID de la lista de precios.</li>
</ul></li>
<li><strong>Retorna</strong>: <code>str</code>: Una cadena de texto formateada con la información del producto (claave, precio original, moneda, existencias, si está en promoción) o un mensaje de promoción no encontrada.</li>
<li><strong>Comportamiento</strong>:
<ul>
<li>Construye una consulta SQL que une las tablas <code>productos</code>, <code>existencias</code>, <code>precio</code> y <code>promociones</code>.</li>
<li>Se conecta a MySQL, ejecuta la consulta con los parámetros proporcionados.</li>
<li>Formatea el resultado para indicar la moneda (MXN/USD) y el estado de promoción (si el producto en cuestión está o no en promoción).</li>
<li>Incluye manejo de errores para problemas de conexión a la base de datos o errores inesperados.</li>
</ul></li>
</ul></li>
</ul></li>
</ul>
<p><strong>ct/tools/sales_rules_tool.py</strong></p>
<p>Este módulo define la herramienta <code>sales_rules_tool</code>, que permite al chatbot aplicar reglas de promoción y calcular el precio final de un producto, considerando la lista de precios y la sucursal del usuario.</p>
<ul>
<li><strong>Clases y funciones clave</strong>:
<ul>
<li><code>SUCURSALES</code>:
<ul>
<li><strong>Propósito</strong>: Un diccionario global cargado desde un archivo JSON (<code>ID_SUCURSAL</code>) que mapea nemónicos de sucursal a sus IDs.</li>
</ul></li>
<li><code>class SalesInput(BaseModel)</code>:
<ul>
<li><strong>Propósito</strong>: Define el esquema de entrada (parámetros) para la herramienta <code>sales_rule_tool</code> utilizando Pydantic.</li>
<li><strong>Atributos</strong>:
<ul>
<li><code>clave (str)</code>: La clave única del producto en promoción.</li>
<li><code>listaPrecio (int)</code>: El ID de la lista de precios a considerar.</li>
<li><code>session_id (str)</code>: El ID de la sesión del usuario, utilizado para inferir la sucursal.</li>
</ul></li>
</ul></li>
<li><code>obtener_id_sucursal(session_id: str) -&gt; str</code>:
<ul>
<li><strong>Propósito</strong>: Extrae el ID de la sucursal a partir del <code>session_id</code> del usuario, utilizando patrones predefinidos (e.g., “XXCTIN” o nemónicos como “HMO”).</li>
<li><strong>Parámetros</strong>:
<ul>
<li><code>session_id (str)</code>: El ID de la sesión del usuario.</li>
</ul></li>
<li><strong>Retorna</strong>: <code>str</code>: El ID de la sucursal como una cadena.</li>
<li><strong>Comportamiento</strong>: Utiliza expresiones regulares para extraer el nemónico o ID de la sucursal del <code>session_id</code> y lo busca en el diccionario <code>SUCURSALES</code>. Lanza <code>ValueError</code> si no puede extraer o encontrar la sucursal.</li>
</ul></li>
<li><code>query_sales()</code>:
<ul>
<li><strong>Propósito</strong>: Retorna la consulta SQL para obtener los detalles de la promoción más relevante para un producto, lista de precios y sucursal específicos.</li>
<li><strong>Parámetros</strong>: Ninguno.</li>
<li><strong>Retorna</strong>: <code>str</code>: La cadena de la consulta SQL.</li>
<li><strong>Comportamiento</strong>: La consulta filtra por promociones activas, producto, lista de precios y sucursal, ordenando por fecha de inicio para obtener la promoción más reciente.</li>
</ul></li>
<li><code>sales_rules_tool(clave: str, listaPrecio: int, session_id: str) -&gt; str</code>:
<ul>
<li><strong>Propósito</strong>: Aplica las reglas de promoción para un producto dado, calculando el precio final y generando un mensaje descriptivo para el usuario.</li>
<li><strong>Parámetros</strong>:
<ul>
<li><code>clave (str)</code>: La clave del producto.</li>
<li><code>listaPrecio (int)</code>: El ID de la lista de precios.</li>
<li><code>session_id (str)</code>: El ID de la sesión del usuario.</li>
</ul></li>
<li><strong>Retorna</strong>: <code>str</code>: Una cadena de texto formateada que describe la promoción aplicada (precio, final, descuento, condiciones, vigencia) o un mensaje si el producto no está en promoción.</li>
<li><strong>Comportamiento</strong>:
<ul>
<li>Obtiene el <code>id_sucursal</code> usando <code>obtener_id_sucursal()</code>.</li>
<li>Se conecta a MySQL y ejecuta <code>query_sales()</code> para obtener los detalles de la promoción.</li>
<li>Evalúa diferentes tipos de promociones (precio de oferta, descuento porcentual, “en compra de X recibe Y”).</li>
<li>Calcula el <code>precio_final</code> y construye un mensaje descriptivo.</li>
<li>Maneja casos donde la promoción no está vigente o el producto no se encuentra en promoción.</li>
<li>Incluye manejo de errores para problemas de base de datos o errores inesperados.</li>
</ul></li>
</ul></li>
</ul></li>
</ul>
<p><strong>ct/tools/status.py</strong></p>
<p>Este módulo define la herramienta <code>status_tool</code>, que permite al chatbot obtener el estado actual de un pedido a través de su número de factura.</p>
<ul>
<li><strong>Clases y funciones clave</strong>:
<ul>
<li><code>class StatusInput</code>:
<ul>
<li><strong>Propósito</strong>: Modelo de datos Pydantic para validar y describir el argumento de entrada <code>factura</code> requerido por la herramienta.</li>
<li><strong>Comportamiento</strong>: Asegura que el número de factura sea una cadena de texto.</li>
</ul></li>
<li><code>status_tool(factura: str) -&gt; str</code>:
<ul>
<li><strong>Propósito</strong>: Consulta una base de datos de MongoDB para encontrar el estado de un pedido específico usando su número de factura.</li>
<li><strong>Parámetros</strong>: <code>factura</code> (<code>str</code>): El número de factura del pedido.</li>
<li><strong>Retorna</strong>: <code>str</code>: Una descripción textual del estado del pedido (ej. “Pedido entregado al domicilio”, “Pedido en generación”).</li>
<li><strong>Comportamiento</strong>:
<ul>
<li>Conecta a la base de datos de MongoDB. Realiza una consulta para encontrar el documentos del pedido por su folio (<code>factura</code>).</li>
<li>Realiza una consulta para encontrar el documento del pedido por su folio (<code>factura</code>).</li>
<li>Si el pedido es encontrado, navega al último estado registrado en el historial de estados (<code>estatus</code>).</li>
<li>Utiliza una declaración <code>match</code> para mapear los estados de la base de datos (ej. ‘Pendiente’, ‘Enviado’, ‘Entregado’) a descripciones amigables para el usuario.</li>
<li>Maneja casos especiales como el estado de ‘Transito’ para formatear la fecha y hora de manera legible.</li>
<li>Devuelve un mensaje apropiado si el pedido no es encontrado.</li>
</ul></li>
</ul></li>
</ul></li>
</ul>
<p><strong>ct/moderation/query_moderator.py</strong></p>
<p>Este módulo se encarga de clasificar las consultas del usuario (relevante, irrelevante, inapropiado) y de gestionar el comportamiento inapropiado, incluyendo la aplicación de sanciones temporales.</p>
<ul>
<li><strong>Clases y funciones claves</strong>:
<ul>
<li><code>class QueryModerator</code>:
<ul>
<li><code>__init__(model: str = "gemma3:4b", assistant : ToolAgent = None)</code>:
<ul>
<li><strong>Propósito</strong>: Inicializa el moderador de consultas, configurando el modelo LLM para clasificación y una referencia al <code>ToolAgent</code> para interactuar con la base de datos de sesiones.</li>
<li><strong>Parámetros</strong>:
<ul>
<li><code>model (str)</code>: Nombre del modelo de Ollama a utilizar para la clasificación de consultas (por defecto “gemma3:4b”).</li>
<li><code>assistant (ToolAgent)</code>: Instancia del <code>ToolAgent</code> para acceder a la gestión de sesiones en MongoDB.</li>
</ul></li>
</ul></li>
<li><code>classify_query(query: str) -&gt; str</code>
<ul>
<li><strong>Propósito</strong>: Clasifica la consulta del usuario como ‘relevante’, ‘irrelevante’ o ‘inapropiado’ utilizando un modelo de lenguaje.</li>
<li><strong>Parámetros</strong>:
<ul>
<li><code>query (str)</code>: La consulta de texto del usuario.</li>
</ul></li>
<li><strong>Retorna</strong>: Un <code>str</code> con una de las clasificaciones <em>relevante</em>, <em>irrelevante</em>, o <em>inapropiado</em>.</li>
<li><strong>Comportamiento</strong>:
<ul>
<li>Utiliza <code>ollama.generate()</code> con un <code>system_prompt</code> predefinido (<code>_classification_prompt</code>) para guiar la clasificación del modelo.</li>
<li>Configura opciones del modelo como <code>temperature = 0</code> para un comportamiento determinista.</li>
</ul></li>
</ul></li>
<li><code>_classification_prompt(self) -&gt; str</code>:
<ul>
<li><strong>Propósito</strong>: Retorna el <em>system prompt</em> utilizado por el modelo de clasificación para categorizar las consultas del usuario.</li>
<li><strong>Parámetros</strong>: Ninguno.</li>
<li><strong>Retorna</strong>: <code>str</code>: La cadena de texto del <em>system prompt</em>.</li>
<li><strong>Comportamiento</strong>: Define las reglas y ejemplos para que el LLM clasifique las consultas en las tres categorías.</li>
</ul></li>
<li><code>polite_answer(self) -&gt; str</code>:
<ul>
<li><strong>Propósito</strong>: Devuelve una respuesta predefinida y amigable cuando la consulta del usuario es clasificada como ‘irrelevante’.</li>
<li><strong>Parámetros</strong>: Ninguno.</li>
<li><strong>Retorna</strong>: <code>str</code>: Una cadena de texto con la respuesta cortés.</li>
<li><strong>Comportamiento</strong>: No utiliza un modelo de lenguaje para garantizar rapidez y confiabilidad en la respuesta.</li>
</ul></li>
<li><code>ban_answer(self) -&gt; str</code>:
<ul>
<li><strong>Propósito</strong>: Devuelve una respuesta predefinida que advierte al usuario sobre el uso de lenguaje inapropiado y las posibles consecuencias.</li>
<li><strong>Parámetros</strong>: Ninguno.</li>
<li><strong>Retorna</strong>: <code>str</code>: Una cadena de texto con el mensaje de advertencia.</li>
<li><strong>Comportamiento</strong>: No utiliza un modelo de lenguaje para garantizar rapidez y control de tono.</li>
</ul></li>
<li><code>evaluate_inappropriate_behavior(self, session: dict, query: str)</code>:
<ul>
<li><strong>Propósito</strong>: Evalúa el comportamiento inapropiado del usuario, incrementa el contador de intentos y determina la duración de una posible sanción (baneo progresivo).</li>
<li><strong>Parámetros</strong>:
<ul>
<li><code>session (dict)</code>: El documento de la sesión del usuario, que contiene el historial de intentos inapropiados y el estado de baneo.</li>
<li><code>query (str)</code>: La consulta inapropiada actual del usuario.</li>
<li><strong>Retorna</strong>: <code>tuple[str, int, Optional[datetime]]</code>: Una tupla que contiene:
<ul>
<li><code>msg (str)</code>: El mensaje de sanción a mostrar al usuario.</li>
<li><code>tries (int)</code>: El número actualizado de intentos inapropiados.</li>
<li><code>banned_until (Optional[datetime])</code>: La fecha y hora hasta la cual el usuario estará baneado (o <code>None</code> si es solo una advertencia).</li>
</ul></li>
<li><strong>Comportamiento</strong>:
<ul>
<li>Implementa una lógica de escalamiuento progresivo de sanciones (advertencia, 1 min, 3 min, 10 min, 1 hora, 1 día, 7 días) basada en el número de intentos.</li>
<li>Reinicia el contador de intentos si ha pasado suficiente tiempo desde el último incidente.</li>
</ul></li>
</ul></li>
</ul></li>
<li><code>check_if_banned(self, session: dict) -&gt; Optional[str]</code>:
<ul>
<li><strong>Propósito</strong>: Verifica si el usuario asociado a una sesión está actualmente baneado. Si el baneo ha expirado, limpia el estado de baneo en la base de datos. Verifica si el usuario está actualmente baneado.</li>
<li><strong>Parámetros</strong>:
<ul>
<li><code>session (dict)</code>: El documento de la sesión del usuario.</li>
</ul></li>
<li><strong>Retorna</strong>: <code>Optional[str]</code>: Un mensaje de baneo si el usuario está actualmente restringido, o <code>None</code> si no está baneado o si el baneo ha expirado.</li>
<li><strong>Comportamiento</strong>: Compara la fecha y hora actual con la fecha <code>banned_until</code> de la sesión. Si el baneo ha expirado, actualiza la sesión en MongoDB para eliminar el campo <code>banned_until</code>.</li>
</ul></li>
<li><code>update_inappropriate_session(self, session, tries, banned_until)</code>:
<ul>
<li><strong>Propósito</strong>: Actualiza los campos relacionados con el comportamiento inapropiado (<code>inappropiate_tries</code>, <code>last_inappropiate</code>, <code>banned_until</code>) en el documento de la sesión del usuario en MongoDB.</li>
<li><strong>Parámetros</strong>:
<ul>
<li><code>session_id (str)</code>: ID de la sesión.</li>
<li><code>tries (int)</code>: El número de intentos inapropiados.</li>
<li><code>banned_until (Optional[datetime])</code>: La fecha y hora hasta la que el usuario está baneado (o <code>None</code>).</li>
</ul></li>
<li><strong>Comportamiento</strong>: Realiza una operación de <code>update_one</code> en la colección <code>sessions</code> para establecer los campos especificados.</li>
</ul></li>
</ul></li>
</ul></li>
</ul>
<p><strong>ct/langchain/moderated_tool_agent.py</strong></p>
<p>Este módulo orquesta el flujo completo de una consulta de usuario, incluyendo la moderación de contenido y la delegación de la consulta al agente principal de herramientas (<code>ToolAgent</code>) si es relevante.</p>
<ul>
<li><strong>Clases y funciones claves</strong>:
<ul>
<li><code>class ModeratedToolAgent</code>:
<ul>
<li><code>__init__(self)</code>:
<ul>
<li><strong>Propósito</strong>: Inicializa el <code>ModeratedToolAgent</code>, creando instancias de <code>ToolAgent</code> y <code>QueryModerator</code> y vinculándolos para coordinar el flujo de la conversación.</li>
<li><strong>Comportamiento</strong>:
<ul>
<li>Crea <code>self.tool_agent</code> para manejar la lógica principal del chatbot y la interración con herramientas.</li>
<li>Crea <code>self.moderator</code> para la clasificación y gestión de comportamiento, pasándole <code>self.tool_agent</code> para que el moderador pueda actualizar el estado de la sesión.</li>
</ul></li>
</ul></li>
<li><code>run</code></li>
</ul>
<div class="sourceCode" id="cb27"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="cf">async</span> <span class="kw">def</span> run(</span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a> query: <span class="bu">str</span>, </span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a> session_id: <span class="bu">str</span> <span class="op">=</span> <span class="va">None</span>, </span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a> listaPrecio: <span class="bu">str</span> <span class="op">=</span> <span class="va">None</span></span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a> ) <span class="op">-&gt;</span> AsyncGenerator[<span class="bu">str</span>, <span class="va">None</span>]: </span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ul>
<li><strong>Propósito</strong>: Ejecuta el flujo completo de una consulta del usuario, desde la verificación de baneo y la clasificación, hasta la generación de la respuesta (relevante, irrelevante, inapropiado) y su <em>streaming</em>.</li>
<li><strong>Parámetros</strong>:
<ul>
<li><code>query (str)</code>: La consulta de texto del usuario.</li>
<li><code>session_id (str)</code>: ID de la sesión del usuario.</li>
<li><code>listaPrecio (str)</code>: El nivel de lista de precios asociado al usuario.</li>
</ul></li>
<li><strong>Retorna</strong>: <code>AsyncGenerator[str, None]</code>: Un generador asíncrono que cede fragmentos (<code>chunks</code>) de la respuesta final del chatbot.</li>
<li><strong>Comportamiento</strong>:
<ul>
<li>Asegura la existencia de la sesión (<code>tool_agent.ensure_session</code>).</li>
<li>Verifica si el usuario está baneado (<code>moderator.check_if_banned</code>). Si lo está, cede el mensaje de baneo y termina.</li>
<li>Clasifica la <code>query</code> (<code>moderator.classify_query</code>).</li>
<li>Basado en la <code>label</code> de clasificación:
<ul>
<li>Si es <em>relevante</em>, delega la ejecución al <code>tool_agent.run()</code> para obtener una respuesta detallada con herramientas.</li>
<li>Si es <em>irrelevante</em>, genera una respuesta cortés (<code>moderator.polite_answer()</code>) y la registra.</li>
<li>Si es <em>inapropiado</em>, evalúa el comportamiento (<code>moderator.evaluate_inappropriate_behavior()</code>), actualiza la sesión (<code>moderator.update_inappropriate_session()</code>) y cede el mensaje de sanción.</li>
<li>Si la clasificación no es reconocida, cede un mensaje de error genérico.</li>
</ul></li>
</ul></li>
</ul></li>
</ul></li>
</ul>
<p><strong>ct/chat.py</strong></p>
<p>Este módulo define los <em>endpoints</em> de la API FastAPI para la interacción del chat y la gestión del historial de sesiones, sirviendo como la interfaz principal entre el <em>frontend</em> y la lógica del chatbot.</p>
<ul>
<li><strong>Funciones clave</strong>:
<ul>
<li><code>assistant = ModeratedToolAgent()</code>:
<ul>
<li><strong>Propósito</strong>: Inicializa una instancia global de <code>ModeratedToolAgent</code> que será utilizada por todos los <em>endpoints</em> del chat.</li>
<li><strong>Comportamiento</strong>: Se crea una única instancia para mantener el estado y las conexiones a la base de datos.</li>
</ul></li>
<li><code>get_chat_history(user_id: str) -&gt; list[dict[str, str]]</code>:
<ul>
<li><strong>Propósito</strong>: Devuelve el historial de chat de un usuario específico en un formato JSON amigable para el <em>frontend</em>. Recupera el historial de chat de un usuario específico.</li>
<li><strong>Parámetros</strong>:
<ul>
<li><code>user_id (str)</code>: El ID del usuario cuyo historial se desea recuperar.</li>
</ul></li>
<li><strong>Retorna</strong>: <code>List[Dict[str, str]]</code>: Una lista de diccionarios, donde cada diccionario representa un mensaje con las claves <em>role</em> (<em>user</em> o <em>bot</em>) y <em>content</em> (el texto del mensaje). Retorna una lista vacía si no hay historial.</li>
<li><strong>Comportamiento</strong>: Llama a <code>assistant.tool_agent.get_session_history()</code> para obtener el historial de LangChain y lo transforma al formato JSON deseado.</li>
</ul></li>
<li><code>async_chat_generator(request: QueryRequest) -&gt; AsyncGenerator[str, None]</code>:
<ul>
<li><strong>Propósito</strong>: Un generador asíncrono que envuelve la función <code>run</code> de la clase <code>ModeratedToolAgent</code> para permitir el <em>streaming</em> de respuestas a los clientes de la API.</li>
<li><strong>Parámetros</strong>:
<ul>
<li><code>request (QueryRequest)</code>: Un objeto Pydantic que contiene la consulta del usuario (<code>user_query</code>), el ID del usuario (<code>user_id</code>), y la lista de precios (<code>listaPrecio</code>).</li>
</ul></li>
<li><strong>Retorna</strong>: <code>AsyncGenerator[str, None]</code>: Cede los fragmentos de respuesta directamente desde el <code>assistant.run()</code>.</li>
</ul></li>
<li><code>async_chat_endpoint(request: QueryRequest) -&gt; StreamingResponse</code>:
<ul>
<li><strong>Propósito</strong>: El <em>endpoint</em> HTTP POST principal para recibir nuevas consultas de chat de los usuarios y devolver respuestas en <em>streaming</em> (Server-Sent Events).</li>
<li><strong>Parámetros</strong>
<ul>
<li><code>request (QueryRequest)</code>: Objeto de solicitud Pydantic con la consulta del usuario, ID de usuario y lista de precios.</li>
</ul></li>
<li><strong>Retorna</strong>: <code>StreamingResponse</code>: Una respuesta HTTP que permite al cliente recibir los fragmentos de la respuesta en tiempo real a medida que se generan.</li>
<li><strong>Comportamiento</strong>: Envuelve el <code>async_chat_generator</code> en una <code>StreamingResponse</code> con <code>media_type="text/event-stream"</code>.</li>
</ul></li>
<li><code>delete_chat_history_endpoint(user_id: str) -&gt; str</code>:
<ul>
<li><strong>Propósito</strong>: <em>Endpoint</em> HTTP DELETE para eliminar el historial de chat de un usuario específico.</li>
<li><strong>Parámetros</strong>:
<ul>
<li><code>user_id (str)</code>: El ID del usuario cuyo historial se va a eliminar.</li>
</ul></li>
<li><strong>Retorna</strong>: <code>str</code>: Una cadena “success” si la eliminación fue exitosa.</li>
<li><strong>Comportamiento</strong>: Llama a <code>assistant.tool_agent.clear_session_history()</code> para borrar el historial. Maneja excepciones y levanta una <code>HTTPException</code> en caso de error interno.</li>
</ul></li>
</ul></li>
</ul>
<p><strong>ct/main.py</strong></p>
<p>Es el archivo principal de la aplicación FastAPI. Configura la aplicación, habilita CORS y registra los <em>endpoints</em> definidos en <code>ct.chat</code>.</p>
<ul>
<li><strong>Funciones clave</strong>:
<ul>
<li><code>app = FastAPI</code>: Inicializa la aplicación FastAPI.</li>
<li><code>app.add_middleware(CORSMiddleware, ...)</code>: Configura el middleware de CORS para permitir solicitudes desde cualquier origen, métodos y cabeceras, lo cual es crucial para la integración del <em>widget</em> en diferentes dominios.</li>
<li><code>@app.get("/history/{user_id}")</code>: Decorador que mapea la ruta GET <code>/history/{user_id}</code> a la función <code>handle_history</code>.</li>
<li><code>handle_history(user_id: str)</code>: Llama a <code>get_chat_history</code> de <code>ct.chat</code> para obtener y retornar el historial.</li>
<li><code>@app.post("/chat")</code>: Decorador que mapea la ruta POST <code>/chat</code> a la función <code>handle_chat</code>.</li>
<li><code>handle_chat(request: QueryRequest)</code>: Llama a <code>async_chat_endpoint</code> de <code>ct.chat</code> para manejar la solicitud de chat y el <em>streaming</em> de la respuesta.</li>
<li><code>@app.delete("/history/{user_id}")</code>: Decorador que mapea la ruta DELETE <code>/history/{user_id}</code> a la función <code>handle_delete_history</code>.</li>
<li><code>handle_delete_history(user_id: str)</code>: Llama a <code>delete_chat_history_endpoint</code> de <code>ct.chat</code> para borrar el historial de un usuario.</li>
<li><code>if __name__ == "__main__":</code>: Bloque de ejecución principal para correr la aplicación con Uvicorn en desarrollo. En producción con Gunicorn.</li>
</ul></li>
</ul>
<p><strong>ct/ETL/extraction.py</strong>:</p>
<p>Módulo de la capa de Extracción. Responsable de conectarse a la base de datos MySQL para extraer información de productos y promociones, y de interactuar con el servicio externo para obtener fichas técnicas.</p>
<ul>
<li><strong>Clases y funciones clave</strong>:
<ul>
<li><code>class Extraction</code>:
<ul>
<li><code>__init__()</code>: Inicializa la clase con los parámetros de conexión a MySQL y configura un <code>cloudscraper</code> para la extracción de fichas técnicas.
<ul>
<li><strong>Parámetros</strong>: Ninguno explícito, lee de <code>ct.clients</code>.</li>
<li><strong>Comportamiento</strong>: Establece <code>scraper</code> con <em>headers</em> personalizados para los tokens de la API y <em>cookies</em>.</li>
</ul></li>
<li><code>ids_query() -&gt; str</code>: Retorna la consulta SQL para obtener IDs de productos válidos (con existencias y precios).</li>
<li><code>get_valid_ids() -&gt; list</code>: Ejecuta la consulta <code>ids_query</code> y retorna una lista de IDs de productos válidos.
<ul>
<li><strong>Retorna</strong>: <code>list</code>: Lista de IDs de productos.</li>
<li><strong>Comportamiento</strong>: Se conecta a MySQL, ejecuta la consulta y maneja errores de conexión.</li>
</ul></li>
<li><code>product_query(id) -&gt; str</code>: Retorna la consulta SQL para obtener detalles de un producto específico por ID. Incluye detalles de precios por lista, categoría, marca, etc.</li>
<li><code>get_products() -&gt; pd.DataFrame</code>: Extrae la información de todos los productos válidos desde MySQL.
<ul>
<li><strong>Retorna</strong>: <code>pd.DataFrame</code>: Un DataFrame de Pandas con la información de los productos.</li>
<li><strong>Comportamientos</strong>: Itera sobre los IDs válidos, ejecuta <code>product_query</code> para cada uno y consolida los resultados en un DataFrame.</li>
</ul></li>
<li><code>current_sales_query() -&gt; str</code>: Retorna la consulta SQL para obtener las promociones vigentes.</li>
<li><code>get_current_sales() -&gt; pd.DataFrame</code>: Extrae las promociones vigentes desde MySQL.
<ul>
<li><strong>Retorna</strong>: <code>pd.DataFrame</code>: Un DataFrame de Pandas con la información de las promociones.</li>
</ul></li>
<li><code>get_specifications_cloudscraper</code>:</li>
</ul>
<div class="sourceCode" id="cb28"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a>get_specifications_cloudscraper(</span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>    claves: List[<span class="bu">str</span>],</span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a>    max_retries: <span class="bu">int</span> <span class="op">=</span> <span class="dv">3</span>,</span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a>    sleep_seconds: <span class="bu">float</span> <span class="op">=</span> <span class="fl">0.15</span></span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a>) <span class="op">-&gt;</span> Dict[<span class="bu">str</span>, <span class="bu">dict</span>]</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
Intenta obtener las fichas técnicas para una lista de claves de productos desde un servicio externo, utilizando <code>cloudscraper</code> para manejar posibles protecciones como Cloudflare.
<ul>
<li><strong>Parámetros</strong>:
<ul>
<li><code>claves (List[str])</code>: Lista de claves de productos.</li>
<li><code>max_retries (int)</code>: Número máximo de reintentos por cada clave.</li>
<li><code>sleep_seconds (float)</code>: Tiempo inicial de espera entre reintentos (con <em>backoff</em> exponencial).</li>
</ul></li>
<li><strong>Retorna</strong>: <code>Dict[str, dict]</code>: Un diccionario donde la clave es la <code>claveProducto</code> y el valor es la ficha técnica en formato JSON.</li>
<li><strong>Comportamiento</strong>: Realiza solicitudes POST al <code>url</code> del servicio de fichas técnicas. Implementa lógica de reintentos con <em>backoff</em> controlado y maneja diversos errores HTTP (ej., 403 Forbidden) y errores de JSON/red.</li>
</ul></li>
</ul></li>
</ul>
<p><strong>ct/ETL/transform.py</strong></p>
<p>Módulo de la capa de Transformación. Se encarga de limpiar, unificar y normalizar los datos extraídos, y de persistir las fichas técnicas en MongoDB.</p>
<ul>
<li><strong>Clases y funciones claves</strong>:
<ul>
<li><code>class Transform</code>:
<ul>
<li><code>__init__()</code>: Inicializa la clase <code>Transform</code>, creando una instancia de <code>Extraction</code> y configurando la conexión a la colección de especificaciones de producto.
<ul>
<li><strong>Parámetros</strong>:
<ul>
<li><code>specifications (dict)</code>: El diccionario que contiene los datos de la ficha técnica de un producto.</li>
</ul></li>
<li><strong>Retorna</strong>: Un diccionario estructurado con <code>fichaTecnica</code> (pares nombre-valor de características) y <code>resumen</code> (descripciones cortas y largas).</li>
<li><strong>Comportamiento</strong>: Navega a través de la estructura anidada de <code>ProductFeature</code> y <code>SummaryDescription</code> para extraer la información.</li>
</ul></li>
<li><code>transform_specifications(specs: dict) -&gt; dict</code>: Transforma múltiples especificaciones brutas (obtenidas del servicio externo) en un formato limpio.
<ul>
<li><strong>Parámetros</strong>:
<ul>
<li><code>specs (dict)</code>: Diccionario de fichas técnicas brutas, donde la clave es la <code>claveProducto</code>.</li>
</ul></li>
<li><strong>Retorna</strong>: Diccionario con fichas técnicas transformadas y limpias, listas para ser usadas o guardadas.</li>
</ul></li>
<li><code>transform_products() -&gt; pd.DataFrame</code>: Transforma los datos brutos de productos obtenidos de MySQL en un DataFrame limpio y estandarizado.
<ul>
<li><strong>Retorna</strong>: Un DataFrame con columnas relevantes, <code>detalles</code> concatenados y <code>detalles_precio</code> parseado de JSON.</li>
</ul></li>
<li><code>clean_products() -&gt; dict</code>: Limpia los datos de productos y los enriquece con las fichas técnicas. Primero busca en MongoDB y si no encuentra, las extrae y las guarda.
<ul>
<li><strong>Retorna</strong>: Un diccionario de productos limpios y enriquecidos, listos para la carga final.</li>
<li><strong>Comportamiento</strong>: Identifica las claves de productos para las que faltan fichas técnicas en MongoDB, las extrae usando <code>self.data.get_specifications</code>, las transforma y las guarda en la colección <code>specifications</code>. Finalmente, combina las fichas técnicas existentes y nuevas con los datos de productos.</li>
</ul></li>
<li><code>transform_sales() -&gt; pd.DataFrame</code>: Transforma los datos brutos de promociones (ventas) en un DataFrame limpio.
<ul>
<li><strong>Retorna</strong>: Un DataFrame con información de promociones, fechas formateadas y descuentos con símbolo de porcentaje.</li>
</ul></li>
<li><code>clean_sales() -&gt; dict</code>: Limpia los datos de promociones y los enriquece con fichas técnicas de manera similar a <code>clean_products()</code>.
<ul>
<li><strong>Retorna</strong>: Un diccionario de promociones limpias y enriquecidas con fichas técnicas.</li>
</ul></li>
</ul></li>
</ul></li>
</ul>
<p><strong>ct/ETL/load.py</strong></p>
<p>Módulo de la capa de Carga. Maneja la inserción de los datos transformados en las colecciones de MongoDB y la construcción de la base de datos vectorial.</p>
<ul>
<li><strong>Clases y funciones clave</strong>:
<ul>
<li><code>class Load</code>:
<ul>
<li><code>__init__()</code>: Inicializa la clase <code>Load</code>, creando una instancia de <code>Transform</code> y configurando las conexiones a las colecciones de MongoDB (<code>products</code>, <code>sales</code>, <code>specifications</code>) y el <em>embedder</em> de OpenAI.</li>
<li><code>build_content(product: dict, product_features: list) -&gt; str</code>: Contruye el contenido textual de un documento a partir de un diccionario de producto y una lista de características.
<ul>
<li><strong>Parámetros</strong>:
<ul>
<li><code>product (dict)</code>: Un diccionario con los datos de un producto.</li>
<li><code>product_features (list)</code>: Lista de claves de características a incluir en el contenido.</li>
</ul></li>
<li><strong>Retorna</strong>: Una cadena de texto concatenada que resume el producto, adecuada para la vectorización.</li>
</ul></li>
<li><code>mongo_products()</code>: Carga las promociones limpias (procesadas por <code>Transform</code>) en la colección <code>products</code> de MongoDB, realizando <em>upserts</em>.</li>
<li><code>mongo_sales()</code>: Carga las promociones limpias (procesadas por <code>Transform</code>) en la colección <code>sales</code> de MongoDB, realizando <em>upserts</em>.</li>
<li><code>load_products() -&gt; List[Document]</code>: Carga los productos desde la colección <code>products</code> de MongoDB y los convierte en objetos <code>langchain.schema.Document</code>.
<ul>
<li><strong>Retorna</strong>: Una instancia del índice FAISS.</li>
</ul></li>
<li><code>products_vs()</code>: Crea o actualiza el <em>vector store</em> para productos.
<ul>
<li><strong>Comportamiento</strong>: Carga los productos desde MongoDB, los vectoriza en lotes (<code>batch_size = 250</code>) para optimizar el uso de memoria, y guarda el índice FAISS localmente en <code>PRODUCTS_VECTOR_PATH</code>.</li>
</ul></li>
<li><code>sales_products_vs()</code>: Crea o actualiza el <em>vector store</em> para ventas/ofertas.
<ul>
<li><strong>Comportamiento</strong>: Carga las ofertas desde MongoDB. Luego, carga el <em>vector store</em> de productos existente desde <code>PRODUCTS_VECTOR_PATH</code> y añade las ofertas a este índice (también en lotes), guardando el índice combinado en <code>SALES_PRODUCTS_VECTOR_PATH</code>.</li>
</ul></li>
</ul></li>
</ul></li>
</ul>
<p><strong>ct/ETL/pipeline.py</strong></p>
<p>Este módulo actúa como el orquestador principal del proceso ETL (Extracción, Transformación, Carga). Centraliza la ejecución de las etapas de obtención, limpieza, enriquecimiento y carga de datos, asegurando que los vector stores de productos y promociones estén siempre actualizados.</p>
<ul>
<li><strong>Clases y funciones clave</strong>:
<ul>
<li><code>run_etl_pipeline()</code>:
<ul>
<li><strong>Propósito</strong>: Función principal que coordina la ejecución secuencial de todas las fases del pipeline ETL.</li>
<li><strong>Comportamiento</strong>:
<ol type="1">
<li>Inicializa una instancia de la clase <code>Load</code>.</li>
<li>Invoca <code>load.products_vs()</code> para crear o actualizar el vector store de productos con los datos preparados.</li>
<li>Invoca <code>load.products_vs()</code> para crear o actualizar el vector store de productos con los datos preparados.</li>
<li>Invoca <code>load.load_sales()</code> para extraer, transformar y preparar los datos de promociones.</li>
<li>Invoca <code>load.sales_products_vs()</code> para crear o actualizar el vector store de promociones, integrándolos con el vector store de productos existente,</li>
</ol></li>
<li><strong>Uso</strong>: Diseñada para ser el punto de entrada para la actualización programada o manual de la base de conocimientos del chatbot.</li>
</ul></li>
</ul></li>
</ul>
</section>
<section id="modelos-llm-utilizados" class="level3">
<h3 class="anchored" data-anchor-id="modelos-llm-utilizados">2.2 Modelos LLM utilizados</h3>
<p>El sistema utiliza una combinación estratégica de modelos de lenguaje para optimizar la funcionalidad y los costos:</p>
<ul>
<li><strong>Clasificación de consultas y respuestas iniciales (Ollama - <code>gemma3:4b</code>)</strong>:
<ul>
<li><strong>Función</strong>: Este modelo <em>open-source</em>, cargado localmente a través de Ollama, es el primer punto de contacto. Su función principal es clasificar las consultas de los usuarios como <em>relevantes</em> (productos que se ofrecen en la empresa), <em>irrelevantes</em> (cualquier producto o tema fuera del ámbito de negocio), o <em>inapropiado</em> (lenguaje ofensivo).</li>
<li><strong>Ventaja</strong>: Permite una gestión eficiente de consultas no relacionadas con el negocio sin incurrir en costos de API’s comerciales, y es ideal para respuestas de “baneo” o corteses.</li>
</ul></li>
<li><strong>Generación de respuestas relevantes (OpenAI - <code>gpt-41</code>)</strong>:
<ul>
<li><strong>Función</strong>: Este modelo avanzado de OpenAI es el encargado de generar las respuestas detalladas y contextualizadas para las consultas clasificadas como <em>relevantes</em>. Trabaja en conjunto con la cadena RAG para integrar la información recuperada de la base de datos vectorial.</li>
<li><strong>Ventaja</strong>: Ofrece alta calidad y precisión en las respuestas, especialmente en el manejo de precios, promociones complejas y detalles de productos, lo que fue validad en pruebas comparativas.</li>
</ul></li>
</ul>
</section>
<section id="puntos-de-entrada-y-funciones-clave" class="level3">
<h3 class="anchored" data-anchor-id="puntos-de-entrada-y-funciones-clave">2.3 Puntos de entrada y funciones clave</h3>
<p>Estos son los principales puntos de inicio para interactuar con las funcionalidades del chatbot. Es crucial que aquí se documenten las funciones y clases <em>directamente expuestas</em> o <em>que inician un flujo principal</em>.</p>
<ul>
<li><code>ModeratedToolAgent.run</code>:</li>
</ul>
<div class="sourceCode" id="cb29"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a>ModeratedToolAgent.run(</span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>  query: <span class="bu">str</span>, </span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a>  session_id: <span class="bu">str</span> <span class="op">=</span> <span class="va">None</span>, </span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a>  listaPrecio: <span class="bu">str</span> <span class="op">=</span> <span class="va">None</span></span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a>  ) <span class="op">-&gt;</span> AsyncGenerator[<span class="bu">str</span>, <span class="va">None</span>]:</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ul>
<li>Es la función principal que orquesta el glujocompleto de una consulta de usuario.</li>
<li><strong>Parámetros</strong>:
<ul>
<li><code>query (str)</code>: La pregunta o entrada del usuario.</li>
<li><code>session_id (str)</code>: Un identificador único para la sesión del usuario, utilizado para mantener el historial correspondiente.</li>
<li><code>listaPrecio (str)</code>: El nivel o clave de precio específico del cliente, que se pasa al LLM para asegurar la precisión de los precios en las consultas dinámicas (ej. precios y promociones).</li>
</ul></li>
<li><strong>Comportamiento</strong>:
<ol type="1">
<li>Verifica si el usuario está actualmente baneado (usando <code>QueryModerator.check_if_banned</code>). Si es así, retorna un mensaje de baneo.</li>
<li>Clasifica la <code>query</code> (usando <code>QueryModerator.classify_query</code>) en una de las categorías: <code>relevante</code>, <code>irrelevante</code>, o <code>inapropiado</code>.</li>
<li>Basado en la clasificación:</li>
</ol>
<ul>
<li><p>Si es <code>relevante</code>, delega la ejecución al <code>ToolAgent.run()</code> para obtener una respuesta detallada con el uso de herramientas y la base de datos vectorial.</p></li>
<li><p>Si es <code>irrelevante</code>, retorna una respuesta predefinida y cortés (QueryModerator.polite_answer()) y registra la interacción.</p></li>
<li><p>Si es <code>inapropiado</code>, evalúa el comportamiento (<code>QueryModerator.evaluate_inappropriate_behavior()</code>), actualiza el estado de baneo en la sesión del usuario (<code>QueryModerator.update_inappropriate_session()</code>) y retorna el mensaje de sanción apropiado.</p></li>
</ul>
<ol start="4" type="1">
<li>Cede fragmentos de la respuesta en tiempo real (streaming).</li>
<li>Registra la interacción completa, incluyendo la pregunta, respuesta y metadatos relevantes para análisis futuro.</li>
</ol></li>
<li><code>ToolAgent.run</code>:</li>
</ul>
<div class="sourceCode" id="cb30"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a>ToolAgent().run(</span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a> session_id: <span class="bu">str</span>, </span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a> question: <span class="bu">str</span>, </span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a> listaPrecio: <span class="bu">str</span></span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a> ) <span class="op">-&gt;</span> AsyncGenerator[<span class="bu">str</span>, <span class="va">None</span>]: </span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ul>
<li><strong>Propósito</strong>: Responde a consultas relevantes de productos, utilizando el agente de LangChain con acceso a herramientas y memoria de conversación. Es la función que el <code>ModeratedToolAgent</code> invoca cuando una consulta es clasificada como relevante.</li>
<li><strong>Parámetros</strong>:
<ul>
<li><code>session_id (str)</code>: ID de la sesión para recuperar/actualizar el historial.</li>
<li><code>question (str)</code>: La pregunta original del usuario.</li>
<li><code>listaPrecio (str)</code>: El nivel de precios del cliente.</li>
</ul></li>
<li><strong>Comportamiento</strong>:
<ol type="1">
<li>Asegura la existencia de la sesión en MongoDB (<code>ensure_session</code>).</li>
<li>Recupera el historial de la sesión (<code>get_session_history</code>) y lo trunca para ajustarse a la ventana de contexto del LLM (<code>trim_messages</code>).</li>
<li>Inicializa el <code>AgentExecutor</code> si no ha sido construido.</li>
<li>Ejecuta la <code>query</code> a través del <code>AgentExecutor</code> de LangChain, que orquesta el uso del LLM y las herramientas (<code>search_information_tool</code>, <code>inventory_tool</code>, <code>sales_rules_tool</code>) según la necesidad de la consulta.</li>
<li>Transmite la respuesta en fragmentos (<code>astream()</code>).</li>
<li>Registra la interacción completa (pregunta, respuesta, métricas como tokens y costo) en las colecciones <code>sessions</code> y <code>message_backup</code> de MongoDB.</li>
</ol></li>
<li><code>load.py::products_vs()</code> y <code>load.py::sales_products_vs()</code>:
<ul>
<li><p><strong>Propósito</strong>: Funciones clave para la creación y actualización incremental de las bases de datos vectoriales (FAISS) de productos y ofertas, respectivamente. Orquestan el proceso de carga de documentos desde MongoDB y su vectorización.</p></li>
<li><p><strong>Comportamiento</strong>:</p>
<ol type="1">
<li><p><code>products_vs()</code>: Carga todos los productos de la colección <code>products</code> de MongoDB, los convierte a <code>langchain.schema.Document</code> y los vectoriza en lotes (<code>batch_size=250</code>) utilizando <code>OpenAIEmbeddings</code>. Finalmente, guarda el índice FAISS resultante en <code>PRODUCTS_VECTOR_PATH</code>.</p></li>
<li><p><code>sales_products_vs()</code>: Carga las ofertas de la colección <code>sales</code> de MongoDB. Luego, carga el índice de productos existente (desde <code>PRODUCTS_VECTOR_PATH</code>) y añade las ofertas a este mismo índice, también en lotes (<code>batch_size=200</code>). Finalmente, guarda el índice combinado (productos + ofertas) en <code>SALES_PRODUCTS_VECTOR_PATH</code>. Esta estrategia asegura que las ofertas se integren sin necesidad de re-vectorizar todo el catálogo de productos, optimizando tiempo y recursos.</p></li>
</ol></li>
</ul></li>
</ul>
</section>
</section>
<section id="guía-de-entrenamiento-y-mejora" class="level2" style="text-align: justify">
<h2 class="anchored" data-anchor-id="guía-de-entrenamiento-y-mejora">3 Guía de entrenamiento y mejora</h2>
<p><strong>Flujo de Datos (ETL)</strong></p>
<p>La información que alimenta la base de conocimientos del chatbot sigue un proceso ETL (Extracción, Transformación, Carga) estructurado que garantiza que el modelo tenga acceso a datos actualizados, limpios y ricos en contexto semántico.</p>
<p><strong>Para una descripción detallada de cada etapa del proceso ETL (Extracción de MySQL y servicio externo de fichas técnicas, Transformación para limpieza, unificación y estructuración, y Carga en MongoDB y la base de datos vectorial FAISS), por favor, consulta el documento “Preparación de los datos”.</strong></p>
<section id="generación-de-la-base-de-datos-vectorial" class="level3">
<h3 class="anchored" data-anchor-id="generación-de-la-base-de-datos-vectorial">3.1 Generación de la base de datos vectorial</h3>
<p>La base de datos vectorial FAISS es el corazón del sistema RAG, almacenando las representaciones vectoriales de la información de productos y promociones para búsquedas de similitud eficientes. Su generación y actualización son parte integral del proceso ETL, el cual asegura que el modelo tenga acceso a una base de conocimiento robusta y actualizada.</p>
<p><strong>Los detalles sobre el proceso de creación del índice vectorial, el uso de embeddings, la estrategia de procesamiento en lotes y la inclusión incremental de ofertas se encuentran descritos exhaustivamente en el documento “Preparación de los datos”.</strong></p>
</section>
<section id="recomendaciones-para-futura-mejora" class="level3">
<h3 class="anchored" data-anchor-id="recomendaciones-para-futura-mejora">3.2 Recomendaciones para futura mejora</h3>
<ol type="1">
<li><strong>Embeddings locales (Ollama)</strong>:</li>
</ol>
<p>Para reducir los costos asociados con los <em>embeddings</em> de OpenAI y disminuir la dependencia de servicios externos, se recomienda realizar pruebas con los modelos de <em>embeddings</em> disponibles a través de Ollama (u otras librerías de <em>embeddings</em> locales).</p>
<ol start="2" type="1">
<li><strong>Indexado incremental</strong>:</li>
</ol>
<p>Actualmente, la actualización de la base vectorial puede implicar procesar grandes lotes. Para un mantenimiento más eficiente, especialmente si solo cambian algunos productos o sus precios/promociones, se podría implementar una función de actualización a nivel de producto.</p>
<ol start="3" type="1">
<li><strong>Monitoreo avanzado de rendimiento</strong>:</li>
</ol>
<p>Aunque ya se registran métricas de costo y duración, se puede profundizar en el monitoreo.</p>
<ol start="4" type="1">
<li><strong>Optimización del manejo de promociones complejas</strong>:</li>
</ol>
<p>Las promociones tipo “en compra X lleva Y” aún presenta desafíos. Podría ser necesario enriquecer el contexto del <em>embedding</em> para estos productos específicos, reglas más explícitas dentro del LLM o creación de plantillas de <em>prompts</em> más específicos para estas promociones.</p>
</section>
</section>
<section id="diagrama-de-arquitectura" class="level2" style="text-align: justify">
<h2 class="anchored" data-anchor-id="diagrama-de-arquitectura">4 Diagrama de arquitectura</h2>
<p>El siguiente diagrama ilustra la arquitectura general del ssitema del chatbot, mostrando los componentes principales y el flujo de datos desde la interacción del usuario hasta la generación de respuestas y el almacenamiento del historial. Se ha actualizado para reflejar la implementación de MongoDB y los diferentes flujos.</p>
<section id="componentes-clave" class="level3">
<h3 class="anchored" data-anchor-id="componentes-clave">4.1 Componentes clave</h3>
<ul>
<li><strong>Interfaz de usuario (widget del chatbot)</strong>: El componente frontal incrustado en la página web de CT Internacional, permitiendo la interacción directa del usuario.</li>
<li><strong>Servicio intermediario PHP</strong>: Actúa como un puente seguro entre el <em>frontend</em> (HTTPS) y la API del chatbot (HTTPS pero con certificado autofirmado, o sea, no seguro) para resolver problemas de <em>contenido mixto</em>. Si el <em>backend</em> ya está en en HTTPS con un certificado SSL seguro, este componente puede ser obviado.</li>
<li><strong>API del chatbot (FastAPI)</strong>: El servicio <em>backend</em> principal que procesa las consultas de los usuarios, orquesta la recuperación de información y se comunica con los modelos de lenguaje.</li>
<li><strong>Base de datos de productos y promociones (MySQL)</strong>: Almacena la información transaccional y de precios de los productos y promociones de CT Internacional. Es la fuente original de los datos.</li>
<li><strong>Servicio de fichas técnicas</strong>: Fuente de datos para la información detallada y semi-estructurada (XML) de los productos.</li>
<li><strong>Módulo ETL</strong>: Proceso automatizado que:
<ul>
<li>Extrae datos de MySQL y el servicio de fichas técnicas.</li>
<li>Limpia, unifica, y transforma los datos, persistiendo las fichas técnicas en MongoDB.</li>
<li>Carga los datos limpios en colecciones de MongoDB (<code>products</code>, <code>sales</code>, <code>specifications</code>).</li>
</ul></li>
<li><strong>Base de datos NoSQL (MongoDB)</strong>: Almacena las fichas técnicas (<code>specifications</code>), así como el historial de las interacciones de los usuarios (<code>sessions</code>, <code>message_backup</code>).
<ul>
<li><code>sessions</code>: Mantiene los últimos <em>n</em> mensajes de cada usuario para recuperación rápida y una experiencia de usuario fluida.</li>
<li><code>message_backup</code>: Almacena un historial completo de todas las consultas y respuestas con métricas detalladas para fines de análisis y reportes.</li>
</ul></li>
<li><strong>Modelo de embeddings</strong>: Componente encargado de transformar tanto las consultas de los usuarios como la información de los productos en representaciones vectoriales numéricas (usando OpenAI Embeddings).</li>
<li><strong>Base de datos vectorial (FAISS)</strong>: Almacena las representaciones vectoriales de la información de productos y ofertas, permitiendo búsquedas de similitud eficientes. Se actualiza con datos del ETL.</li>
<li><strong>Clasificador de consultas (Ollama - <code>gemma3:4b</code>)</strong>: Componente central que, para consultas relevantes, coordina la búsqueda de información en la base de datos vectorial y contextualiza esta información con la consulta del usuario.</li>
<li><strong>LLM</strong>: El motor principal del chatbot para consultas relevantes, responsable de generar respuestas coherentes y detalladas en base a la consulta contextualizada por el RAG.</li>
<li><strong>Sistema de reportes automatizados</strong>: Procesa los datos del <code>message_backup</code> en MongoDB para generar <em>insights</em> sobre el uso del chatbot, intereses de los clientes, costos y rendimiento.</li>
</ul>
</section>
<section id="flujo-de-interacción-principal" class="level3">
<h3 class="anchored" data-anchor-id="flujo-de-interacción-principal">4.2 Flujo de interacción principal</h3>
<ol type="1">
<li>El <strong>usuario</strong> interactúa con el <strong>widget del chatbot</strong> en la página web.</li>
<li>La consulta se envía a la <strong>API del chatbot</strong> (<strong>potencialmente vía el servicio intermediario PHP</strong>)</li>
<li>La API crea o continúa una <strong>sesión de conversación</strong>, y la consulta es pasada al asistente conversacional.</li>
<li>Si la consulta es <em>relevante</em>:</li>
</ol>
<ul>
<li><code>search_information_tool</code>: busca productos relevantes.</li>
<li><code>inventory_tool</code>: obtiene precios, existencias y moneda por clave de producto.</li>
<li><code>sales_rules_tool</code>: calcula el precio final considerando promociones o reglas de negocio.</li>
<li>La información recuperada se contextualiza y se envía al <strong>LLM</strong> para generar la <strong>respuesta al usuario</strong>.</li>
</ul>
<ol start="5" type="1">
<li>Si la consulta es <em>irrelevante</em> o <em>inapropiada</em>, el <strong>clasificador</strong> genera una respuesta adecuada (cortés o de advertencia) directamente al <strong>usuario</strong>.</li>
<li>Todas las interacciones (consultas y respuestas) se registran en las colecciones <code>sessions</code> y <code>message_backup</code> en <strong>MongoDB</strong>.</li>
<li>El <strong>sistema de reportes automatizados</strong> accede a <code>message_backup</code> para generar análisis de datos.</li>
</ol>
</section>
<section id="flujo-de-datos" class="level3">
<h3 class="anchored" data-anchor-id="flujo-de-datos">4.3 Flujo de datos</h3>
<ol type="1">
<li>El <strong>módulo ETL</strong> extrae datos de <strong>MySQL</strong> y el <strong>servicio de fichas técnicas</strong>.</li>
<li>Los datos se transforman y las fichas técnicas se cargan en <strong>MongoDB</strong> (colección <code>specifications</code>).</li>
<li>Los datos transformados de <code>products</code> y <code>sales</code> (incluyendo las fichas técnicas obtenidas de MongoDB) son utilizados por el <strong>módulo ETL</strong> para construir y actualizar la <strong>base de datos vectorial</strong>.</li>
</ol>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="./arquitectura.jpg" class="img-fluid figure-img" style="width:120.0%"></p>
<figcaption>Arquitectura del sistema</figcaption>
</figure>
</div>
</section>
</section>



<a onclick="window.scrollTo(0, 0); return false;" role="button" id="quarto-back-to-top"><i class="bi bi-arrow-up"></i> Volver arriba</a></main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const disableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'prefetch';
    }
  }
  const enableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'stylesheet';
    }
  }
  const manageTransitions = (selector, allowTransitions) => {
    const els = window.document.querySelectorAll(selector);
    for (let i=0; i < els.length; i++) {
      const el = els[i];
      if (allowTransitions) {
        el.classList.remove('notransition');
      } else {
        el.classList.add('notransition');
      }
    }
  }
  const toggleGiscusIfUsed = (isAlternate, darkModeDefault) => {
    const baseTheme = document.querySelector('#giscus-base-theme')?.value ?? 'light';
    const alternateTheme = document.querySelector('#giscus-alt-theme')?.value ?? 'dark';
    let newTheme = '';
    if(darkModeDefault) {
      newTheme = isAlternate ? baseTheme : alternateTheme;
    } else {
      newTheme = isAlternate ? alternateTheme : baseTheme;
    }
    const changeGiscusTheme = () => {
      // From: https://github.com/giscus/giscus/issues/336
      const sendMessage = (message) => {
        const iframe = document.querySelector('iframe.giscus-frame');
        if (!iframe) return;
        iframe.contentWindow.postMessage({ giscus: message }, 'https://giscus.app');
      }
      sendMessage({
        setConfig: {
          theme: newTheme
        }
      });
    }
    const isGiscussLoaded = window.document.querySelector('iframe.giscus-frame') !== null;
    if (isGiscussLoaded) {
      changeGiscusTheme();
    }
  }
  const toggleColorMode = (alternate) => {
    // Switch the stylesheets
    const alternateStylesheets = window.document.querySelectorAll('link.quarto-color-scheme.quarto-color-alternate');
    manageTransitions('#quarto-margin-sidebar .nav-link', false);
    if (alternate) {
      enableStylesheet(alternateStylesheets);
      for (const sheetNode of alternateStylesheets) {
        if (sheetNode.id === "quarto-bootstrap") {
          toggleBodyColorMode(sheetNode);
        }
      }
    } else {
      disableStylesheet(alternateStylesheets);
      toggleBodyColorPrimary();
    }
    manageTransitions('#quarto-margin-sidebar .nav-link', true);
    // Switch the toggles
    const toggles = window.document.querySelectorAll('.quarto-color-scheme-toggle');
    for (let i=0; i < toggles.length; i++) {
      const toggle = toggles[i];
      if (toggle) {
        if (alternate) {
          toggle.classList.add("alternate");     
        } else {
          toggle.classList.remove("alternate");
        }
      }
    }
    // Hack to workaround the fact that safari doesn't
    // properly recolor the scrollbar when toggling (#1455)
    if (navigator.userAgent.indexOf('Safari') > 0 && navigator.userAgent.indexOf('Chrome') == -1) {
      manageTransitions("body", false);
      window.scrollTo(0, 1);
      setTimeout(() => {
        window.scrollTo(0, 0);
        manageTransitions("body", true);
      }, 40);  
    }
  }
  const isFileUrl = () => { 
    return window.location.protocol === 'file:';
  }
  const hasAlternateSentinel = () => {  
    let styleSentinel = getColorSchemeSentinel();
    if (styleSentinel !== null) {
      return styleSentinel === "alternate";
    } else {
      return false;
    }
  }
  const setStyleSentinel = (alternate) => {
    const value = alternate ? "alternate" : "default";
    if (!isFileUrl()) {
      window.localStorage.setItem("quarto-color-scheme", value);
    } else {
      localAlternateSentinel = value;
    }
  }
  const getColorSchemeSentinel = () => {
    if (!isFileUrl()) {
      const storageValue = window.localStorage.getItem("quarto-color-scheme");
      return storageValue != null ? storageValue : localAlternateSentinel;
    } else {
      return localAlternateSentinel;
    }
  }
  const darkModeDefault = false;
  let localAlternateSentinel = darkModeDefault ? 'alternate' : 'default';
  // Dark / light mode switch
  window.quartoToggleColorScheme = () => {
    // Read the current dark / light value 
    let toAlternate = !hasAlternateSentinel();
    toggleColorMode(toAlternate);
    setStyleSentinel(toAlternate);
    toggleGiscusIfUsed(toAlternate, darkModeDefault);
  };
  // Ensure there is a toggle, if there isn't float one in the top right
  if (window.document.querySelector('.quarto-color-scheme-toggle') === null) {
    const a = window.document.createElement('a');
    a.classList.add('top-right');
    a.classList.add('quarto-color-scheme-toggle');
    a.href = "";
    a.onclick = function() { try { window.quartoToggleColorScheme(); } catch {} return false; };
    const i = window.document.createElement("i");
    i.classList.add('bi');
    a.appendChild(i);
    window.document.body.appendChild(a);
  }
  // Switch to dark mode if need be
  if (hasAlternateSentinel()) {
    toggleColorMode(true);
  } else {
    toggleColorMode(false);
  }
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copiado");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copiado");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>