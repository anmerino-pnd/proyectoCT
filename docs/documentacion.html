<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.6.40">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Documentación</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./favicon.png" rel="icon" type="image/png">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-549806ee2085284f45b00abea8c6df48.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-text-highlighting-styles">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-dark-8ea72dc5fed832574809a9c94082fbbb.css" rel="prefetch" class="quarto-color-scheme quarto-color-alternate" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap-ddd961a2510921635943dfbbd19534c4.min.css" rel="stylesheet" append-hash="true" class="quarto-color-scheme" id="quarto-bootstrap" data-mode="light">
<link href="site_libs/bootstrap/bootstrap-dark-ae2d0dcda2edce4ab590422bb373b64f.min.css" rel="prefetch" append-hash="true" class="quarto-color-scheme quarto-color-alternate" id="quarto-bootstrap" data-mode="dark">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


<link rel="stylesheet" href="styles.css">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a href="./index.html" class="navbar-brand navbar-brand-logo">
    <img src="./ctlogo.png" alt="" class="navbar-logo">
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="./home.html"> 
<span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="./comprension.html"> 
<span class="menu-text">Comprensión del negocio</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="./comprension_datos.html"> 
<span class="menu-text">Comprensión de los datos</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="./preparacion.html"> 
<span class="menu-text">Preparación</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="./modelado.html"> 
<span class="menu-text">Modelado y Evaluación</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="./despliegue.html"> 
<span class="menu-text">Despliegue</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link active" href="./documentacion.html" aria-current="page"> 
<span class="menu-text">Documentación</span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
  <a href="" class="quarto-color-scheme-toggle quarto-navigation-tool  px-1" onclick="window.quartoToggleColorScheme(); return false;" title="Toggle dark mode"><i class="bi"></i></a>
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Tabla de Contenidos</h2>
   
  <ul>
  <li><a href="#manual-de-instalación-y-despliegue." id="toc-manual-de-instalación-y-despliegue." class="nav-link active" data-scroll-target="#manual-de-instalación-y-despliegue.">Manual de instalación y despliegue.</a>
  <ul class="collapse">
  <li><a href="#configuraciones-importantes" id="toc-configuraciones-importantes" class="nav-link" data-scroll-target="#configuraciones-importantes">Configuraciones importantes</a></li>
  <li><a href="#requisitios-del-sistema" id="toc-requisitios-del-sistema" class="nav-link" data-scroll-target="#requisitios-del-sistema">Requisitios del sistema</a></li>
  <li><a href="#dependencias-principales-del-sistema" id="toc-dependencias-principales-del-sistema" class="nav-link" data-scroll-target="#dependencias-principales-del-sistema">Dependencias principales del sistema</a></li>
  <li><a href="#instalación-del-backend-api" id="toc-instalación-del-backend-api" class="nav-link" data-scroll-target="#instalación-del-backend-api">Instalación del backend (API)</a></li>
  <li><a href="#instalación-del-frontend-widget" id="toc-instalación-del-frontend-widget" class="nav-link" data-scroll-target="#instalación-del-frontend-widget">Instalación del frontend (Widget)</a></li>
  <li><a href="#notas-adicionales" id="toc-notas-adicionales" class="nav-link" data-scroll-target="#notas-adicionales">Notas adicionales</a></li>
  </ul></li>
  <li><a href="#documentación-técnica-del-código-estructura-dependencias-etc.." id="toc-documentación-técnica-del-código-estructura-dependencias-etc.." class="nav-link" data-scroll-target="#documentación-técnica-del-código-estructura-dependencias-etc..">Documentación técnica del código (estructura, dependencias, etc.).</a>
  <ul class="collapse">
  <li><a href="#estructura-de-carpetas-y-módulos" id="toc-estructura-de-carpetas-y-módulos" class="nav-link" data-scroll-target="#estructura-de-carpetas-y-módulos">Estructura de carpetas y módulos</a></li>
  <li><a href="#modelos-llm-utilizados" id="toc-modelos-llm-utilizados" class="nav-link" data-scroll-target="#modelos-llm-utilizados">Modelos LLM utilizados</a></li>
  <li><a href="#puntos-de-entrada-y-funciones-clave" id="toc-puntos-de-entrada-y-funciones-clave" class="nav-link" data-scroll-target="#puntos-de-entrada-y-funciones-clave">Puntos de entrada y funciones clave</a></li>
  </ul></li>
  <li><a href="#guía-de-entrenamiento-y-mejora" id="toc-guía-de-entrenamiento-y-mejora" class="nav-link" data-scroll-target="#guía-de-entrenamiento-y-mejora">Guía de entrenamiento y mejora</a>
  <ul class="collapse">
  <li><a href="#generación-de-la-base-de-datos-vectorial" id="toc-generación-de-la-base-de-datos-vectorial" class="nav-link" data-scroll-target="#generación-de-la-base-de-datos-vectorial">Generación de la base de datos vectorial</a></li>
  <li><a href="#recomendaciones-para-futura-mejora" id="toc-recomendaciones-para-futura-mejora" class="nav-link" data-scroll-target="#recomendaciones-para-futura-mejora">Recomendaciones para futura mejora</a></li>
  </ul></li>
  <li><a href="#diagrama-de-arquitectura" id="toc-diagrama-de-arquitectura" class="nav-link" data-scroll-target="#diagrama-de-arquitectura">Diagrama de arquitectura</a>
  <ul class="collapse">
  <li><a href="#componentes-clave" id="toc-componentes-clave" class="nav-link" data-scroll-target="#componentes-clave">Componentes clave:</a></li>
  <li><a href="#flujo-de-interacción-principal" id="toc-flujo-de-interacción-principal" class="nav-link" data-scroll-target="#flujo-de-interacción-principal">Flujo de interacción principal:</a></li>
  <li><a href="#flujo-de-datos" id="toc-flujo-de-datos" class="nav-link" data-scroll-target="#flujo-de-datos">Flujo de datos</a></li>
  </ul></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Documentación</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<section id="manual-de-instalación-y-despliegue." class="level2" style="text-align: justify">
<h2 class="anchored" data-anchor-id="manual-de-instalación-y-despliegue.">Manual de instalación y despliegue.</h2>
<section id="configuraciones-importantes" class="level3">
<h3 class="anchored" data-anchor-id="configuraciones-importantes">Configuraciones importantes</h3>
<ul>
<li>El proyecto está diseñado para ser desplegado en entornos <strong>Linux o Windows</strong> con <strong>Python 3.12.9</strong>. Requiere acceso a <strong>Ollama</strong> (para la ejecución de modelos <em>open-source</em> como <code>gemma3:12b</code>), así como conectividad a una instancia de <strong>MongoDB</strong> y bases de datos <strong>MySQL</strong>.</li>
<li>La aplicación <em>backend</em> se expone a través de <strong>FastAPI</strong> en el puerto <code>8000</code>. Es crucial asegurar que este puerto esté abierto y accesible en el entorno de despliegue.</li>
<li>Archivo <code>.env</code> con variables cargadas</li>
<li>Todas las credenciales y configuraciones sensibles se gestionan mediante un archivo de variables de entorno (<code>.env</code>), garantizando la seguridad y facilidad de configuración.</li>
</ul>
</section>
<section id="requisitios-del-sistema" class="level3">
<h3 class="anchored" data-anchor-id="requisitios-del-sistema">Requisitios del sistema</h3>
<ul>
<li><strong>Python</strong>: Versión 3.12.9</li>
<li><strong>Pip</strong>: Última versión</li>
<li><strong>UV</strong>: Última versión (gestor de paquetes y entornos)</li>
<li><strong>Ollama</strong>: Instalado y en ejecución en el servidor para el <em>hosting</em> de modelos <em>open-source</em>.</li>
<li><strong>MongoDB</strong>: Acceso remoto configurado para las colecciones de historial, productos, ofertas y fichas técnicas.</li>
<li><strong>MySQL</strong>: Acceso remoto configurado para la extracción de datos de productos y precios.</li>
</ul>
</section>
<section id="dependencias-principales-del-sistema" class="level3">
<h3 class="anchored" data-anchor-id="dependencias-principales-del-sistema">Dependencias principales del sistema</h3>
<ul>
<li><code>langchain</code>: Framework principal para la construcción de cadenas RAG y la orquestación del flujo del chatbot.</li>
<li><code>tiktoken</code>: Utilizado para el conteo preciso de tokens en las consutlas y respuestas, fundamental para la estimación de costos.</li>
<li><code>ollama</code>: Herramienta para servir modelos de lenguaje <em>open-source</em> localmente, como <code>gemma3:12b</code>, permitiendo flexibilidad en la elección del LLM.</li>
<li><code>pymongo</code>: Driver Python para la interacción con MongoDB, utilizado para el almacenamiento y recuperación de sesiones de usuario, historial de mensajes, fichas técnicas, y datos de productos/ofertas.</li>
<li><code>mysql-connector-python</code>: Conector para MySQL, empleado para la extracción de datos de producto, sus detalles y precios desde la base de datos relacional.</li>
<li><code>faiss-cpu</code>: Biblioteca para la búsqueda eficiente de similitudes, crucial para la creación y consulta de la base de datos vectorial donde se almacenan los embeddings de productos.</li>
<li><code>gunicorn</code>: Servidor WSGI utilizado para desplegar la aplicación FastAPI en producción, gestionando la concurrencia y el rendimiento.</li>
<li><strong>Otras dependencias</strong>: Todas las demás librerías requeridas se detallan en el archivo <code>pyproject.toml</code>. La instalación de este archivo se detalla más adelante.</li>
</ul>
</section>
<section id="instalación-del-backend-api" class="level3">
<h3 class="anchored" data-anchor-id="instalación-del-backend-api">Instalación del backend (API)</h3>
<ol type="1">
<li>Clonar el repositorio:</li>
</ol>
<div class="sourceCode" id="cb1"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">git</span> clone https://github.com/anmerino-pnd/proyectoCT</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="bu">cd</span> proyectoCT</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ol start="2" type="1">
<li><p>Crear un entorno virtual e instalar dependencias:</p>
<p>Se recomienda usar <code>uv</code> por su eficiencia.</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="ex">pip</span> install uv <span class="co"># En caso de no estar instalado</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="ex">uv</span> venv</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="bu">source</span> .venv/bin/activate  <span class="co"># Para Linux/macOS</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="co"># o `.venv\Scripts\activate` para Windows</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a><span class="ex">uv</span> pip install <span class="at">-e</span> .</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div></li>
<li><p>Asegurarse de estar corriendo Ollama en el ambiente:</p>
<p>Verifica que el servicio de Ollama esté instalado y activo, y que el modelo <code>gemma3:12b</code> esté disponible.</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="ex">curl</span> <span class="at">-fsSL</span> https://ollama.com/install.sh <span class="kw">|</span> <span class="fu">sh</span> <span class="co"># Para instalar Ollama</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="ex">ollama</span> serve</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="ex">ollama</span> list <span class="co"># Para verificar que el modelo gemma3:12b esté descargado y listo</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a><span class="ex">ollama</span> pull gemma3:12b <span class="co"># Correr esta línea en caso que el modelo no aparezca</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div></li>
<li><p>Configurar variables de entorno:</p>
<p>Antes de levantar el <em>backend</em>, asegurarse de que el archivo <code>.env</code> en la raíz del proyecto contenga las siguientes variables con sus valores correctos.</p></li>
</ol>
<div class="sourceCode" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Conexión a la base de datos SQL</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>ip<span class="op">=</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>port<span class="op">=</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>user<span class="op">=</span></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>pwd<span class="op">=</span></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>db<span class="op">=</span></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Clave de la API de OpenAI para correr sus modelos</span></span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>OPENAI_API_KEY<span class="op">=</span></span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Configuración para el servicio de fichas técnicas</span></span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a>url<span class="op">=</span> <span class="st">''</span> </span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a>Token<span class="op">-</span>api<span class="op">=</span><span class="st">''</span></span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a>Token<span class="op">-</span>ct<span class="op">=</span><span class="st">''</span></span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a>Content<span class="op">-</span>Type<span class="op">=</span><span class="st">''</span></span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a>Cookie<span class="op">=</span><span class="st">''</span></span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a>dominio<span class="op">=</span><span class="st">""</span></span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true" tabindex="-1"></a>boundary<span class="op">=</span><span class="st">''</span></span>
<span id="cb4-20"><a href="#cb4-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-21"><a href="#cb4-21" aria-hidden="true" tabindex="-1"></a><span class="co"># Conexión a MongoDB</span></span>
<span id="cb4-22"><a href="#cb4-22" aria-hidden="true" tabindex="-1"></a>MONGO_URI <span class="op">=</span> <span class="st">"mongodb://"</span> <span class="co"># En la URI debe estar incrustrado el nombre de la DB</span></span>
<span id="cb4-23"><a href="#cb4-23" aria-hidden="true" tabindex="-1"></a>MONGO_COLLECTION_SESSIONS <span class="op">=</span> <span class="st">""</span></span>
<span id="cb4-24"><a href="#cb4-24" aria-hidden="true" tabindex="-1"></a>MONGO_COLLECTION_MESSAGE_BACKUP <span class="op">=</span> <span class="st">""</span></span>
<span id="cb4-25"><a href="#cb4-25" aria-hidden="true" tabindex="-1"></a>MONGO_COLLECTION_PRODUCTS <span class="op">=</span> <span class="st">""</span></span>
<span id="cb4-26"><a href="#cb4-26" aria-hidden="true" tabindex="-1"></a>MONGO_COLLECTION_SALES <span class="op">=</span> <span class="st">""</span>         </span>
<span id="cb4-27"><a href="#cb4-27" aria-hidden="true" tabindex="-1"></a>MONGO_COLLECTION_SPECIFICATIONS <span class="op">=</span> <span class="st">""</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ol start="5" type="1">
<li>Levantar el backend con Gunicorn:</li>
</ol>
<p>Este comando inicia la API, especificando el número de <em>workers</em>, el <em>binding</em> de IP y puerto, y la configuración de SSL/TLS para HTTPS.</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="fu">nohup</span> gunicorn ct.main:app   <span class="at">--workers</span> 4   <span class="at">--bind</span> 0.0.0.0:8000   <span class="at">--certfile</span><span class="op">=</span>static/ssl/cert.pem   <span class="at">--keyfile</span><span class="op">=</span>static/ssl/key.pem   <span class="at">-k</span> uvicorn.workers.UvicornWorker   <span class="at">--access-logfile</span> <span class="at">-</span>   <span class="at">--error-logfile</span> <span class="at">-</span> <span class="kw">&amp;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>El uso de <code>nogup</code> y <code>&amp;</code> asegura que el proceso continúe ejecutándose en segundo plano incluso si la sesión SSH se cierra.</p>
<ol start="6" type="1">
<li>Regenerar el certificado SSL (si expira o es necesario):</li>
</ol>
<p>Si el certificado SSL autofirmado ha expirado o necesitas uno nuevo:</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="ex">openssl</span> req <span class="at">-x509</span> <span class="at">-newkey</span> rsa:2048 <span class="at">-nodes</span> <span class="at">-keyout</span> ssl/key.pem <span class="at">-out</span> ssl/cert.pem&nbsp;-days&nbsp;365</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Asegurarse de que los archivos <code>cert.pem</code> y <code>key.pem</code> estén en la ruta <code>ssl</code> dentro de tu proyecto.</p>
</section>
<section id="instalación-del-frontend-widget" class="level3">
<h3 class="anchored" data-anchor-id="instalación-del-frontend-widget">Instalación del frontend (Widget)</h3>
<ol type="1">
<li><p><strong>Cargar archivos del widget</strong>: Los archivos del <em>frontend</em> (principalmente <code>sdk.js</code> y cualquier recurso gráfico como <code>chat.png</code>) deben ser cargados en el servidor donde reside el <em>frontend</em> de la página.</p></li>
<li><p><strong>Incrustar el widget en el HTML</strong>: Ejemplo de cómo se puede añadir el widget en la página web donde se desea que aparezca el chatbot.</p></li>
</ol>
<div class="sourceCode" id="cb7"><pre class="sourceCode html code-with-copy"><code class="sourceCode html"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;!DOCTYPE</span> html<span class="dt">&gt;</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;</span><span class="kw">html</span><span class="ot"> lang</span><span class="op">=</span><span class="st">"es"</span><span class="dt">&gt;</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;</span><span class="kw">head</span><span class="dt">&gt;</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&lt;</span><span class="kw">meta</span><span class="ot"> charset</span><span class="op">=</span><span class="st">"UTF-8"</span><span class="ot"> </span><span class="dt">/&gt;</span></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&lt;</span><span class="kw">title</span><span class="dt">&gt;</span>Prueba del Widget<span class="dt">&lt;/</span><span class="kw">title</span><span class="dt">&gt;</span></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;/</span><span class="kw">head</span><span class="dt">&gt;</span></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;</span><span class="kw">body</span><span class="dt">&gt;</span></span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&lt;</span><span class="kw">script</span><span class="ot"> </span></span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a><span class="ot">    src</span><span class="op">=</span><span class="st">"sdk.js"</span><span class="ot"> </span></span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a><span class="ot">    data-user-id</span><span class="op">=</span><span class="st">"test"</span><span class="ot"> </span></span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a><span class="ot">    data-user-key</span><span class="op">=</span><span class="st">"2"</span><span class="ot"> </span></span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a><span class="ot">    data-api-base</span><span class="op">=</span><span class="st">"https://ctdev.ctonline.mx/chatbot"</span><span class="ot"> </span></span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a><span class="ot">    data-chat-icon-url</span><span class="op">=</span><span class="st">"chat.png"</span><span class="ot"> </span></span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a><span class="ot">    type=</span><span class="st">"text/javascript"</span><span class="dt">&gt;</span></span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&lt;/</span><span class="kw">script</span><span class="dt">&gt;</span></span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;/</span><span class="kw">body</span><span class="dt">&gt;</span></span>
<span id="cb7-17"><a href="#cb7-17" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;/</span><span class="kw">html</span><span class="dt">&gt;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><strong>Notas importantes para el <code>data-api-base</code>:</strong></p>
<ul>
<li>Si la API corre en HTTP y el <em>frontend</em> en HTTPS, se enfrentarán problemas de “contenido mixto”. La solución propuesta fue usar un archivo PHP (<em>backend</em> del sitio web) como intermediario, el cual es crucial aquí. La API debe apuntar a este PHP y el PHP a su <em>frontend</em> donde se encuentra el widget.</li>
<li>La <code>data-api-base</code> es el dominio donde es accesible la API mediante PHP.</li>
</ul>
</section>
<section id="notas-adicionales" class="level3">
<h3 class="anchored" data-anchor-id="notas-adicionales">Notas adicionales</h3>
<ul>
<li><strong>Problemas de caché</strong>: Es común que los navegadores almacenen versiones antiguas de archivos JS/CSS. Si la interfaz del <em>widget</em> no funciona correctamente después de una actualización, instruye a los usuarios a limpiar la caché de su navegador o a realizar un “hard refresh” (Ctrl+F5). Implementar una estrategia de <em>versioning</em> para los archivos del <em>widget</em> (ej.js?v=1.2.3) puede mitigar esto a futuro.</li>
<li><strong>Rotación de IP para fichas técnicas</strong>: El sistema está diseñado para manejar el bloqueo de IP del servicio de fichas técnicas. Se recomienda monitorear los logs de la extracción (<code>extraction.py</code>) para identificar errores 403, lo que indicaría la necesidad de actualizar la IP en el servicio externo.</li>
</ul>
</section>
</section>
<section id="documentación-técnica-del-código-estructura-dependencias-etc.." class="level2" style="text-align: justify">
<h2 class="anchored" data-anchor-id="documentación-técnica-del-código-estructura-dependencias-etc..">Documentación técnica del código (estructura, dependencias, etc.).</h2>
<section id="estructura-de-carpetas-y-módulos" class="level3">
<h3 class="anchored" data-anchor-id="estructura-de-carpetas-y-módulos">Estructura de carpetas y módulos</h3>
<p>El proyecto sigue una estructura modular para facilitar la gestión y el mantenimiento. A continuación, se detalla el propósito de los módulos principales y algunas de sus funciones clave:</p>
<p><strong>ct/langchain/vectorstore.py</strong></p>
<ul>
<li>Este módulo implementa la lógica para la creación, carga y consulta de la base de datos vectorial FAISS. Gestiona el retriever que busca los documentos más relevantes.</li>
<li><strong>Clases y funciones clave</strong>:
<ul>
<li><code>class LangchainVectorStore</code>:
<ul>
<li><code>__init__(embedder, index_path: str = None)</code>: Inicializa el <em>vector store</em>.
<ul>
<li><strong>Parámetros</strong>:
<ul>
<li><code>embedder</code>: Una instancia de la clase <em>embedder</em> utilizada para generar los <em>embeddings</em> (ej., <code>OpenAIEmbeddings(openai_api_key=openai_api_key)</code>).</li>
<li><code>index_path</code> (<code>str</code>): Ruta al directorio donde se guardará o cargará en el índice FAISS.</li>
</ul></li>
<li><strong>Comportarmiento</strong>: Si <code>index_path</code> existe, carga el índice preexistente. Configura un <code>retriever</code> con <code>k=10</code> (top 10 documentos) y <code>score_threshold=0.8</code> para la búsqueda.</li>
</ul></li>
<li><code>_load_index()</code>: Carga un índice FAISS existente desde disco.
<ul>
<li><strong>Parámetros</strong>: Ninguno (usa <code>self.index_path</code>).</li>
<li><strong>Comportamiento</strong>: Carga el índice y configura <code>self.retriever</code> búsquedas. Es una función interna.</li>
</ul></li>
</ul></li>
</ul></li>
</ul>
<p><strong>ct/langchain/assistant.py</strong></p>
<ul>
<li>Contiene la lógica central del chatbot, incluyendo la gestión del historial de sesiones (a través de MongoDB), la creación de las cadenas RAG con memoria conversacional y la interacción con el LLM de OpenAI.</li>
<li><strong>Clases y funciones clave</strong>:
<ul>
<li><code>class LangchainAssistant</code>:
<ul>
<li><code>__init__(retriever)</code>: Inicializa el asistente del chatbot.
<ul>
<li><strong>Parámetros</strong>:
<ul>
<li><code>retriever</code>: Una instancia de un <strong>retriever</strong> (ej., <code>vectorstore.retriever</code>) que proporciona documentos relevantes.</li>
</ul></li>
<li><strong>Comportamiento</strong>: Configura el LLM (OpenAI), las conexiones a MongoDB para <code>sessions</code> y <code>message_backup</code>, define el tamaño de la ventana de memoria (<code>memory_window_size</code>), y construye la cadena RAG principal (<code>rag_chain</code>).</li>
</ul></li>
<li><code>get_session_history(session_id: str) -&gt; List[BaseMessage]</code>: Recupera el historial de chat de una sesión específica desde MongoDB.
<ul>
<li><strong>Parámetros</strong>:
<ul>
<li><code>session_id (str)</code>: El identificador único de la sesión del usuario.</li>
</ul></li>
<li><strong>Retorna</strong>: <code>List[BaseMessage]</code>: Una lista de objetos <code>HumanMessage</code> y <code>AIMessage</code> que representan la conversación previa.</li>
</ul></li>
<li><code>clear_session_history(session_id: str)</code>: Elimina el historial de mensajes de una sesión específica en MongoDB.
<ul>
<li><strong>Parámetros</strong>:
<ul>
<li><code>session_id (str)</code>: El identificador único de la sesión a borrar.</li>
</ul></li>
<li><strong>Retorna</strong>: <code>bool: True</code> si la operación fue exitosa, <code>False</code> en caso contrario.</li>
</ul></li>
<li><code>ensure_session(session: str)</code>: Asegura que exista una entrada para la <code>session_id</code> en la colección <code>sessions</code> de MongoDB, o la crea si no existe.
<ul>
<li><strong>Parámetros</strong>:
<ul>
<li><code>session_id (str)</code>: El identificador de la sesión.</li>
</ul></li>
<li><strong>Comportamiento</strong>: Actualiza la última actividad de la sesión o inserta una nueva sesión.</li>
</ul></li>
<li><code>build_chain()</code>: Construye la cadena RAG que incorpora el historial de chat.
<ul>
<li><strong>Parámetros</strong>: Ninguno.</li>
<li><strong>Retorna</strong>: Una instancia de <code>langchain.chains.create_retrieval_chain</code> configurada para manejar el historial y la recuperación de documentos.</li>
</ul></li>
<li><code>answer</code>:</li>
</ul>
<div class="sourceCode" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>answer(</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a> session_id: <span class="bu">str</span>, </span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a> question: <span class="bu">str</span>, </span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a> listaPrecio: <span class="bu">str</span> <span class="op">=</span> <span class="va">None</span></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a> ) <span class="op">-&gt;</span> AsyncGenerator[<span class="bu">str</span>, <span class="va">None</span>]: </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
Responde a una consulta del usuario, transmitiendo la respuesta en tiempo real.
<ul>
<li><strong>Parámetros</strong>:
<ul>
<li><code>session_id (str)</code>: ID de la sesión del usuario.</li>
<li><code>question (str)</code>: La pregunta del usuario.</li>
<li><code>listaPrecio (str)</code>: El nivel de lista de precios asociado al usuario, usado en el <em>prompt</em> del LLM.</li>
</ul></li>
<li><strong>Retorna</strong>: <code>AsyncGenerator[str, None]</code>: Un generador asíncrono que cede fragmentos (<code>chunks</code>) de la respuesta a medida que se generan.</li>
<li><strong>Comportamiento</strong>: Recupera el historial, lo trunca si es muy largo, ejecuta la cadena RAG, recopila métricas de tokens/costo/duración y persiste el mensaje en <code>sessions</code> y <code>message_backup</code>.</li>
<li><code>add_message</code></li>
</ul>
<div class="sourceCode" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>add_message(</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a> session_id: <span class="bu">str</span>, </span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a> message_type: <span class="bu">str</span>, </span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a> content: <span class="bu">str</span>, </span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a> metadata: <span class="bu">dict</span> <span class="op">=</span> <span class="va">None</span>): </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
Agrega un mensaje a la colección <code>sessions</code> para mantener un historial de ventana.
<ul>
<li><strong>Parámetros</strong>:
<ul>
<li><code>session_id (str)</code>: ID de la sesión.</li>
<li><code>message_type (str)</code>: <em>human</em> o <em>assistant</em>.</li>
<li><code>content (str)</code>: Contenido del mensaje.</li>
<li><code>metadata (dict)</code>: Metadatos adicionales (usado para mensajes del asistente).</li>
</ul></li>
<li><strong>Comportamiento</strong>: Inserta el mensaje y trunca la colección <code>last_messages</code> a un tamaño fijo (actualmente 50 mensajes) para optimizar el rendimiento.</li>
<li><code>add_message_backup</code></li>
</ul>
<div class="sourceCode" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>add_message_backup(</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a> session_id: <span class="bu">str</span>, </span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a> question: <span class="bu">str</span>, </span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a> full_answer: <span class="bu">str</span>, </span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a> metadata: <span class="bu">dict</span> <span class="op">=</span> <span class="va">None</span>): </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
Guarda un respaldo completo de cada interacción (pregunta y respuesta) junto con métricas detalladas en la colección <code>message_backup</code>.
<ul>
<li><strong>Parámetros</strong>:
<ul>
<li><code>session_id (str)</code>: ID de la sesión.</li>
<li><code>message_type (str)</code>: <em>human</em> o <em>assistant</em>.</li>
<li><code>content (str)</code>: Contenido del mensaje.</li>
<li><code>metadata (dict)</code>: Metadatos adicionales (usado para mensajes del asistente).</li>
</ul></li>
<li><strong>Comportamiento</strong>: Inserta un nuevo documento en <code>message_backup</code> con toda la información relevante para análisis posterior.</li>
</ul></li>
</ul></li>
</ul>
<p><strong>ct/langchain/rag.py</strong></p>
<ul>
<li>Orquesta el flujo completo de una consulta de usuario, incluyendo la clasificación de la intención y la delegación a los modelos adecuados.</li>
<li><strong>Clases y funciones claves</strong>:
<ul>
<li><code>class LangchainRAG</code>:
<ul>
<li><code>__init__(index_path: str = None)</code>: Inicializa el orquestador RAG.
<ul>
<li><strong>Parámetros</strong>:
<ul>
<li><code>index_path (str)</code>: Ruta al índice FAISS.</li>
</ul></li>
<li><strong>Comportamiento</strong>: Inicializa el <em>embedder</em>, el <em>vector store</em> (cargando el índice si existe), y el asistente de LangChain. Configura el modelo Ollama (<code>gemma3:1b</code>) para la clasificación.</li>
</ul></li>
<li><code>classify_query(query: str) -&gt; str</code>: Clasifica la consulta del usuario.
<ul>
<li><strong>Parámetros</strong>:
<ul>
<li><code>query (str)</code>: La consulta del usuario.</li>
</ul></li>
<li><strong>Retorna</strong>: Un <code>str</code> con una de las clasificaciones <em>relevante</em>, <em>irrelevante</em>, o <em>inapropiado</em>.</li>
<li><strong>Comportamiento</strong>: Utiliza un modelo Ollama (<code>gemma3:1b</code>) con un <em>system prompt</em> específico para realizar la clasificación.</li>
</ul></li>
<li><code>polite_answer(query: str) -&gt; AsyncGenerator[str, None]</code>: Genera una respuesta cortés para consultas irrelevantes.
<ul>
<li><strong>Parámetros</strong>:
<ul>
<li><code>query (str)</code>: La consulta del usuario.</li>
<li><strong>Retorna</strong>: <code>AsyncGenerator[str, None]</code>: Cede fragmentos de una respuesta amigable indicando que la consulta está fuera de tema.</li>
<li><strong>Comportamiento</strong>: Usa el modelo Ollama (<code>gemma3:1b</code>) con un <em>system prompt</em> que lo instruye a ser cortés y redirigir al usuario a temas tecnológicos.</li>
</ul></li>
</ul></li>
<li><code>ban_answer(query: str) -&gt; AsyncGenerator[str, None]</code>: Genera una respuesta firme para consultas inapropiadas.
<ul>
<li><strong>Parámetros</strong>:
<ul>
<li><code>query (str)</code>: La consulta original del usuario.</li>
</ul></li>
<li><strong>Retorna</strong>: <code>AsyncGenerator[str, None]</code>: Cede fragmentos de una respuesta que prohíbe el lenguaje inapropiado y advierte de un posible bloqueo.</li>
<li><strong>Comportamiento</strong>: Usa el modelo Ollama (<code>gemma3:1b</code>) con un <em>system prompt</em> que exige una respuesta directa y sin concensiones.</li>
</ul></li>
<li><code>run</code></li>
</ul>
<div class="sourceCode" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>run(</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a> query: <span class="bu">str</span>, </span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a> session_id: <span class="bu">str</span> <span class="op">=</span> <span class="va">None</span>, </span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a> listaPrecio: <span class="bu">str</span> <span class="op">=</span> <span class="va">None</span></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a> ) <span class="op">-&gt;</span> AsyncGenerator[<span class="bu">str</span>, <span class="va">None</span>]: </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
Ejecuta el flujo completo de la consulta del usuario.
<ul>
<li><strong>Parámetros</strong>:
<ul>
<li><code>query (str)</code>: La consulta del usuario.</li>
<li><code>session_id (str)</code>: ID de la sesión.</li>
<li><code>listaPrecio (str)</code>: Nivel de lista de precios.</li>
</ul></li>
<li><strong>Retorna</strong>: <code>AsyncGenerator[str, None]</code>: Cede fragmentos de la respuesta final del chatbot.</li>
<li><strong>Comportamiento</strong>: Primero clasifica la consulta. Dependiendo de la clasificación, llama a <code>assistant.answer</code> (para relevante), <code>polite_answer</code> (para irrelevante) o <code>ban_answer</code> (para inapropiado).</li>
</ul></li>
</ul></li>
</ul>
<p><strong>ct/chat.py</strong></p>
<ul>
<li>Define los <em>endpoints</em> de la API para la interacción del chat y la gestión del historial de sesiones.</li>
<li><strong>Funciones clave</strong>:
<ul>
<li><code>get_chat_history(user_id: str)</code>: Recupera el historial de chat de un usuario específico.
<ul>
<li><strong>Parámetros</strong>:
<ul>
<li><code>user_id (str)</code>: El ID del usuario cuyo historial se desea recuperar.</li>
</ul></li>
<li><strong>Retorna</strong>: <code>List[Dict[str, str]]</code>: Una lista de diccionarios, donde cada diccionario representa un mensaje con <em>role</em> (<em>user</em> o <em>bot</em>) y <em>content</em>.</li>
<li><strong>Comportamiento</strong>: Llama a <code>assistant.get_session_history()</code> y formatea la respuesta.</li>
</ul></li>
<li><code>async_chat_generator(request: QueryRequest) -&gt; AsyncGenerator[str, None]</code>: Un generador asíncrono que envuelve la función <code>run</code> de la clase <code>LangchainRAG</code> para permitir el <em>streaming</em> de respuestas.
<ul>
<li><strong>Parámetros</strong>:
<ul>
<li><code>request (QueryRequest)</code>: Un objeto que contiene <code>user_query</code>, <code>user_id</code>, y <code>listaPrecio</code>.</li>
</ul></li>
<li><strong>Retorna</strong>: <code>AsyncGenerator[str, None]</code>: Cede los fragmentos de respuesta directamente desde el <code>rag.run(query: str, session_id: str, listaPrecio: str)</code>.</li>
</ul></li>
<li><code>async_chat_endpoint(request: QueryRequest)</code>: El <em>endpoint</em> HTTP POST para recibir nuevas consultas de chat y devolver respuestas en <em>streaming</em>.
<ul>
<li><strong>Parámetros</strong>
<ul>
<li><code>request (QueryRequest)</code>: Objeto de solicitud Pydantic con la consulta del usuario, ID de usuario y lista de precios.</li>
</ul></li>
<li><strong>Retorna</strong>: <code>StreamingResponse</code>: Una respuesta HTTP que permite al cliente recibir los fragmentos de la respuesta en tiempo real.</li>
</ul></li>
<li><code>delete_chat_history_endpoint(user_id: str)</code>: El <em>endpoint</em> HTTP DELETE para eliminar el historial de chat de un usuario.
<ul>
<li><strong>Parámetros</strong>:
<ul>
<li><code>user_id (str)</code>: El ID del usuario cuyo historial se va a eliminar.</li>
</ul></li>
<li><strong>Retorna</strong>: Un <code>str</code> que indica “success” si la eliminación fue exitosa.</li>
<li><strong>Comportamiento</strong>: Llama a <code>assistant.clear_session_history()</code> y maneja excepciones.</li>
</ul></li>
</ul></li>
</ul>
<p><strong>ct/main.py</strong></p>
<ul>
<li>Es el archivo principal de la aplicación FastAPI. Configura la aplicación, habilita CORS y registra los <em>endpoints</em> definidos en <code>ct.chat</code>.</li>
<li><strong>Funciones clave</strong>:
<ul>
<li><code>app = FastAPI</code>: Inicializa la aplicación FastAPI.</li>
<li><code>app.add_middleware(CORSMiddleware, ...)</code>: Configura el middleware de CORS para permitir solicitudes desde cualquier origen, métodos y cabeceras, lo cual es crucial para la integración del <em>widget</em> en diferentes dominios.</li>
<li><code>@app.get("/history/{user_id}")</code>: Decorador que mapea la ruta GET <code>/history/{user_id}</code> a la función <code>handle_history</code>.</li>
<li><code>handle_history(user_id: str)</code>: Llama a <code>get_chat_history</code> de <code>ct.chat</code> para obtener y retornar el historial.</li>
<li><code>@app.post("/chat")</code>: Decorador que mapea la ruta POST <code>/chat</code> a la función <code>handle_chat</code>.</li>
<li><code>handle_chat(request: QueryRequest)</code>: Llama a <code>async_chat_endpoint</code> de <code>ct.chat</code> para manejar la solicitud de chat y el <em>streaming</em> de la respuesta.</li>
<li><code>@app.delete("/history/{user_id}")</code>: Decorador que mapea la ruta DELETE <code>/history/{user_id}</code> a la función <code>handle_delete_history</code>.</li>
<li><code>handle_delete_history(user_id: str)</code>: Llama a <code>delete_chat_history_endpoint</code> de <code>ct.chat</code> para borrar el historial de un usuario.</li>
<li><code>if __name__ == "__main__":</code>: Bloque de ejecución principal para correr la aplicación con Uvicorn en desarrollo. En producción con Gunicorn.</li>
</ul></li>
</ul>
<p><strong>ct/ETL/extraction.py</strong>:</p>
<ul>
<li>Módulo de la capa de Extracción. Responsable de conectarse a la base de datos MySQL para extraer información de productos y promociones, y de interactuar con el servicio externo para obtener fichas técnicas.</li>
<li><strong>Clases y funciones clave</strong>:
<ul>
<li><code>class Extraction</code>:
<ul>
<li><code>__init__()</code>: Inicializa la clase con los parámetros de conexión a MySQL y configura un <code>cloudscraper</code> para la extracción de fichas técnicas.
<ul>
<li><strong>Parámetros</strong>: Ninguno explícito, lee de <code>ct.clients</code>.</li>
<li><strong>Comportamiento</strong>: Establece <code>scraper</code> con <em>headers</em> personalizados para los tokens de la API y <em>cookies</em>.</li>
</ul></li>
<li><code>ids_query() -&gt; str</code>: Retorna la consulta SQL para obtener IDs de productos válidos (con existencias y precios).</li>
<li><code>get_valid_ids() -&gt; list</code>: Ejecuta la consulta <code>ids_query</code> y retorna una lista de IDs de productos válidos.
<ul>
<li><strong>Retorna</strong>: <code>list</code>: Lista de IDs de productos.</li>
<li><strong>Comportamiento</strong>: Se conecta a MySQL, ejecuta la consulta y maneja errores de conexión.</li>
</ul></li>
<li><code>product_query(id) -&gt; str</code>: Retorna la consulta SQL para obtener detalles de un producto específico por ID. Incluye detalles de precios por lista, categoría, marca, etc.</li>
<li><code>get_products() -&gt; pd.DataFrame</code>: Extrae la información de todos los productos válidos desde MySQL.
<ul>
<li><strong>Retorna</strong>: <code>pd.DataFrame</code>: Un DataFrame de Pandas con la información de los productos.</li>
<li><strong>Comportamientos</strong>: Itera sobre los IDs válidos, ejecuta <code>product_query</code> para cada uno y consolida los resultados en un DataFrame.</li>
</ul></li>
<li><code>current_sales_query() -&gt; str</code>: Retorna la consulta SQL para obtener las promociones vigentes.</li>
<li><code>get_current_sales() -&gt; pd.DataFrame</code>: Extrae las promociones vigentes desde MySQL.
<ul>
<li><strong>Retorna</strong>: <code>pd.DataFrame</code>: Un DataFrame de Pandas con la información de las promociones.</li>
</ul></li>
<li><code>get_specifications_cloudscraper</code>:</li>
</ul>
<div class="sourceCode" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>get_specifications_cloudscraper(</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>    claves: List[<span class="bu">str</span>],</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>    max_retries: <span class="bu">int</span> <span class="op">=</span> <span class="dv">3</span>,</span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>    sleep_seconds: <span class="bu">float</span> <span class="op">=</span> <span class="fl">0.15</span></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>) <span class="op">-&gt;</span> Dict[<span class="bu">str</span>, <span class="bu">dict</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
Intenta obtener las fichas técnicas para una lista de claves de productos desde un servicio externo, utilizando <code>cloudscraper</code> para manejar posibles protecciones como Cloudflare.
<ul>
<li><strong>Parámetros</strong>:
<ul>
<li><code>claves (List[str])</code>: Lista de claves de productos.</li>
<li><code>max_retries (int)</code>: Número máximo de reintentos por cada clave.</li>
<li><code>sleep_seconds (float)</code>: Tiempo inicial de espera entre reintentos (con <em>backoff</em> exponencial).</li>
</ul></li>
<li><strong>Retorna</strong>: <code>Dict[str, dict]</code>: Un diccionario donde la clave es la <code>claveProducto</code> y el valor es la ficha técnica en formato JSON.</li>
<li><strong>Comportamiento</strong>: Realiza solicitudes POST al <code>url</code> del servicio de fichas técnicas. Implementa lógica de reintentos con <em>backoff</em> controlado y maneja diversos errores HTTP (ej., 403 Forbidden) y errores de JSON/red.</li>
</ul></li>
</ul></li>
</ul>
<p><strong>ct/ETL/transform.py</strong></p>
<ul>
<li>Módulo de la capa de Transformación. Se encarga de limpiar, unificar y normalizar los datos extraídos, y de persistir las fichas técnicas en MongoDB.</li>
<li><strong>Clases y funciones claves</strong>:
<ul>
<li><code>class Transform</code>:
<ul>
<li><code>__init__()</code>: Inicializa la clase <code>Transform</code>, creando una instancia de <code>Extraction</code> y configurando la conexión a la colección de especificaciones de producto.
<ul>
<li><strong>Parámetros</strong>:
<ul>
<li><code>specifications (dict)</code>: El diccionario que contiene los datos de la ficha técnica de un producto.</li>
</ul></li>
<li><strong>Retorna</strong>: Un diccionario estructurado con <code>fichaTecnica</code> (pares nombre-valor de características) y <code>resumen</code> (descripciones cortas y largas).</li>
<li><strong>Comportamiento</strong>: Navega a través de la estructura anidada de <code>ProductFeature</code> y <code>SummaryDescription</code> para extraer la información.</li>
</ul></li>
<li><code>transform_specifications(specs: dict) -&gt; dict</code>: Transforma múltiples especificaciones brutas (obtenidas del servicio externo) en un formato limpio.
<ul>
<li><strong>Parámetros</strong>:
<ul>
<li><code>specs (dict)</code>: Diccionario de fichas técnicas brutas, donde la clave es la <code>claveProducto</code>.</li>
</ul></li>
<li><strong>Retorna</strong>: Diccionario con fichas técnicas transformadas y limpias, listas para ser usadas o guardadas.</li>
</ul></li>
<li><code>transform_products() -&gt; pd.DataFrame</code>: Transforma los datos brutos de productos obtenidos de MySQL en un DataFrame limpio y estandarizado.
<ul>
<li><strong>Retorna</strong>: Un DataFrame con columnas relevantes, <code>detalles</code> concatenados y <code>detalles_precio</code> parseado de JSON.</li>
</ul></li>
<li><code>clean_products() -&gt; dict</code>: Limpia los datos de productos y los enriquece con las fichas técnicas. Primero busca en MongoDB y si no encuentra, las extrae y las guarda.
<ul>
<li><strong>Retorna</strong>: Un diccionario de productos limpios y enriquecidos, listos para la carga final.</li>
<li><strong>Comportamiento</strong>: Identifica las claves de productos para las que faltan fichas técnicas en MongoDB, las extrae usando <code>self.data.get_specifications</code>, las transforma y las guarda en la colección <code>specifications</code>. Finalmente, combina las fichas técnicas existentes y nuevas con los datos de productos.</li>
</ul></li>
<li><code>transform_sales() -&gt; pd.DataFrame</code>: Transforma los datos brutos de promociones (ventas) en un DataFrame limpio.
<ul>
<li><strong>Retorna</strong>: Un DataFrame con información de promociones, fechas formateadas y descuentos con símbolo de porcentaje.</li>
</ul></li>
<li><code>clean_sales() -&gt; dict</code>: Limpia los datos de promociones y los enriquece con fichas técnicas de manera similar a <code>clean_products()</code>.
<ul>
<li><strong>Retorna</strong>: Un diccionario de promociones limpias y enriquecidas con fichas técnicas.</li>
</ul></li>
</ul></li>
</ul></li>
</ul>
<p><strong>ct/ETL/load.py</strong></p>
<ul>
<li>Módulo de la capa de Carga. Maneja la inserción de los datos transformados en las colecciones de MongoDB y la construcción de la base de datos vectorial.</li>
<li><strong>Clases y funciones clave</strong>:
<ul>
<li><code>class Load</code>:
<ul>
<li><code>__init__()</code>: Inicializa la clase <code>Load</code>, creando una instancia de <code>Transform</code> y configurando las conexiones a las colecciones de MongoDB (<code>products</code>, <code>sales</code>, <code>specifications</code>) y el <em>embedder</em> de OpenAI.</li>
<li><code>build_content(product: dict, product_features: list) -&gt; str</code>: Contruye el contenido textual de un documento a partir de un diccionario de producto y una lista de características.
<ul>
<li><strong>Parámetros</strong>:
<ul>
<li><code>product (dict)</code>: Un diccionario con los datos de un producto.</li>
<li><code>product_features (list)</code>: Lista de claves de características a incluir en el contenido.</li>
</ul></li>
<li><strong>Retorna</strong>: Una cadena de texto concatenada que resume el producto, adecuada para la vectorización.</li>
</ul></li>
<li><code>mongo_products()</code>: Carga las promociones limpias (procesadas por <code>Transform</code>) en la colección <code>products</code> de MongoDB, realizando <em>upserts</em>.</li>
<li><code>mongo_sales()</code>: Carga las promociones limpias (procesadas por <code>Transform</code>) en la colección <code>sales</code> de MongoDB, realizando <em>upserts</em>.</li>
<li><code>load_products() -&gt; List[Document]</code>: Carga los productos desde la colección <code>products</code> de MongoDB y los convierte en objetos <code>langchain.schema.Document</code>.
<ul>
<li><strong>Retorna</strong>: Una instancia del índice FAISS.</li>
</ul></li>
<li><code>products_vs()</code>: Crea o actualiza el <em>vector store</em> para productos.
<ul>
<li><strong>Comportamiento</strong>: Carga los productos desde MongoDB, los vectoriza en lotes (<code>batch_size = 250</code>) para optimizar el uso de memoria, y guarda el índice FAISS localmente en <code>PRODUCTS_VECTOR_PATH</code>.</li>
</ul></li>
<li><code>sales_products_vs()</code>: Crea o actualiza el <em>vector store</em> para ventas/ofertas.
<ul>
<li><strong>Comportamiento</strong>: Carga las ofertas desde MongoDB. Luego, carga el <em>vector store</em> de productos existente desde <code>PRODUCTS_VECTOR_PATH</code> y añade las ofertas a este índice (también en lotes), guardando el índice combinado en <code>SALES_PRODUCTS_VECTOR_PATH</code>.</li>
</ul></li>
</ul></li>
</ul></li>
</ul>
</section>
<section id="modelos-llm-utilizados" class="level3">
<h3 class="anchored" data-anchor-id="modelos-llm-utilizados">Modelos LLM utilizados</h3>
<p>El sistema utiliza una combinación estratégica de modelos de lenguaje para optimizar la funcionalidad y los costos:</p>
<ul>
<li><strong>Clasificación de consultas y respuestas iniciales (Ollama - <code>gemma3:12b</code>)</strong>:
<ul>
<li><strong>Función</strong>: Este modelo <em>open-source</em>, cargado localmente a través de Ollama, es el primer punto de contacto. Su función principal es clasificar las consultas de los usuarios como <em>relevantes</em> (productos que se ofrecen en la empresa), <em>irrelevantes</em> (cualquier producto o tema fuera del ámbito de negocio), o <em>inapropiado</em> (lenguaje ofensivo).</li>
<li><strong>Ventaja</strong>: Permite una gestión eficiente de consultas no relacionadas con el negocio sin incurrir en costos de API’s comerciales, y es ideal para respuestas de “baneo” o corteses.</li>
</ul></li>
<li><strong>Generación de respuestas relevantes (OpenAI - <code>gpt-4o</code>)</strong>:
<ul>
<li><strong>Función</strong>: Este modelo avanzado de OpenAI es el encargado de generar las respuestas detalladas y contextualizadas para las consultas clasificadas como <em>relevantes</em>. Trabaja en conjunto con la cadena RAG para integrar la información recuperada de la base de datos vectorial.</li>
<li><strong>Ventaja</strong>: Ofrece alta calidad y precisión en las respuestas, especialmente en el manejo de precios, promociones complejas y detalles de productos, lo que fue validad en pruebas comparativas.</li>
<li><strong>Nota</strong>: Se ha estado testeado el nuevo modelo <code>gpt-4.1</code> y ha dado buenos resultados. Posiblemente haya una actualización del modelo utilizado por OpenAI.</li>
</ul></li>
</ul>
</section>
<section id="puntos-de-entrada-y-funciones-clave" class="level3">
<h3 class="anchored" data-anchor-id="puntos-de-entrada-y-funciones-clave">Puntos de entrada y funciones clave</h3>
<p>Estos son los principales puntos de inicio para interactuar con las funcionalidades del chatbot:</p>
<ul>
<li><code>LangchainRAG.run</code>:</li>
</ul>
<div class="sourceCode" id="cb13"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>LangchainRAG.run(</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>  query: <span class="bu">str</span>, </span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>  session_id: <span class="bu">str</span> <span class="op">=</span> <span class="va">None</span>, </span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>  listaPrecio: <span class="bu">str</span> <span class="op">=</span> <span class="va">None</span></span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>  ) <span class="op">-&gt;</span> AsyncGenerator[<span class="bu">str</span>, <span class="va">None</span>]:</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ul>
<li>Es la función principal que orquesta el glujocompleto de una consulta de usuario.</li>
<li><strong>Parámetros</strong>:
<ul>
<li><code>query (str)</code>: La pregunta o entrada del usuario.</li>
<li><code>session_id (str)</code>: Un identificador único para la sesión del usuario, utilizado para mantener el historial correspondiente.</li>
<li><code>listaPrecio (str)</code>: El nivel o clave de precio específico del cliente, que se pasa al LLM para asegurar la precisión de los precios.</li>
</ul></li>
<li><strong>Comportamiento</strong>:
<ol type="1">
<li>Clasifica la <code>query</code> (usando <code>rag.classify_query</code>).</li>
<li>Basado en la clasificación (<em>relevante</em>, <em>irrelevante</em>, <em>inapropiado</em>), delega la generación de la respuesta al método apropiado (<code>assistant.answer</code>, <code>rag.polite_answer</code>, <code>rag.ban_answer</code>).</li>
<li>Cede fragmentos de la respuesta en tiempo real.</li>
</ol></li>
<li><code>assistant.answer</code>:</li>
</ul>
<div class="sourceCode" id="cb14"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>assistant.answer(</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a> session_id: <span class="bu">str</span>, </span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a> question: <span class="bu">str</span>, </span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a> listaPrecio: <span class="bu">str</span></span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a> ) <span class="op">-&gt;</span> AsyncGenerator[<span class="bu">str</span>, <span class="va">None</span>]: </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ul>
<li>Responde a consultas relevantes de productos, utilizando la cadena RAG con memoria.</li>
<li><strong>Parámetros</strong>:
<ul>
<li><code>session_id (str)</code>: ID de la sesión para recuperar/actualizar el historial.</li>
<li><code>question (str)</code>: La pregunta original del usuario.</li>
<li><code>listaPrecio (str)</code>: El nivel de precios del cliente.</li>
</ul></li>
<li><strong>Comportamiento</strong>:
<ol type="1">
<li>Asegura la existencia de la sesión en MongoDB (<code>ensure_session</code>).</li>
<li>Recupera el historial de la sesión (<code>get_session_history</code>) y lo trunca a la ventana de memoria definida (<code>memory_window_size</code>).</li>
<li>Ejecuta la cadena RAG (<code>rag_chain</code>), que involucra la recuperación de documentos (<code>retriever</code>) y la generación de respuesta por el LLM.</li>
<li>Transmite la respuesta en fragmentos (<code>yield_chunk_content</code>).</li>
<li>Registra la interacción completa (pregunta, respuesta, métricas) en MongoDB (<code>add_message</code> y <code>add_message_backup</code>).</li>
</ol></li>
<li><code>load.py::products_vs()</code> y <code>load.py::sales_products_vs()</code>:
<ul>
<li>Funciones clave para la creación y actualización incremental de las bases de datos vectoriales de productos y ofertas, respectivamente. Orquestan el proceso de carga de documentos desde MongoDB y su vectorización en FAISS.</li>
<li><strong>Parámetros</strong>: Ninguno.</li>
<li><strong>Comportamiento</strong>:
<ol type="1">
<li><code>products_vs()</code>: Carga todos los productos de la colección <code>products</code> de MongoDB, los vectoriza en lotes para optimizar la memoria y guarda el índice FAISS resultante en <code>PRODUCTS_VECTOR_PATH</code>.</li>
<li><code>sales_products_vs()</code>: Carga las ofertas de la colección <code>sales</code> de MongoDB. Luego, carga el índice de productos existente (desde <code>PRODUCTS_VECTOR_PATH</code>) y añade las ofertas a este mismo índice, también en lotes. Finalmente, guarda el índice combinado (productos + ofertas) en <code>SALES_PRODUCTS_VECTOR_PATH</code>. Esta estrategia asegura que las ofertas se integren sin necesidad de re-vectorizar todo el catálogo de productos.</li>
</ol></li>
</ul></li>
</ul>
</section>
</section>
<section id="guía-de-entrenamiento-y-mejora" class="level2" style="text-align: justify">
<h2 class="anchored" data-anchor-id="guía-de-entrenamiento-y-mejora">Guía de entrenamiento y mejora</h2>
<p>La mejora continua del chatbot se basa en un ciclo ETL robusto y monitoreo constante del rendimiento.</p>
<p><strong>Flujo de Datos (ETL)</strong></p>
<p>La información que alimenta la base de conocimientos del chatbot sigue un proceso ETL (Extracción, Transformación, Carga) bien definido.</p>
<ul>
<li>Extracción:
<ul>
<li>Los datos de productos base (ID, nombre, categoría, marca, tipo, modelo, descripciones, palabras clave, precios por lista de precio) se obtienen directamente de una <strong>base de datos MySQL</strong>.</li>
<li>La información detallada de las fichas técnicas se extrae de un <strong>servicio externo</strong> a través de solicitudes HTTP/HTTPS, que devuelven los datos en formato XML. Se ha implementado un mecanismo de reintentos y manejo de errores (ej. 403 Forbidden por cambio de IP) para extracción.</li>
</ul></li>
<li>Transformación:
<ul>
<li>Esta etapa es crucial para preparar los datos para la vectorización y el consumo por el LLM. Incluye:
<ul>
<li>Limpieza y normalización: Eliminación de valores nulos o inconsistentes, estandarización de formatos.</li>
<li>Unificación de contenido: Concatenación de campos textuales como <code>descripcion</code>. <code>descripcion_corta</code> y <code>palabrasClave</code> en un campo <code>detalles</code> para enriquecer el contexto del <em>embedding</em>.</li>
<li>Integración de fichas técnicas: Los datos de las fichas técnicas XML son parseados y estructurados, combinándose con la información de productos. Las fichas técnicas transformadas se persisten en una colección dedicada en MongoDB (<code>specifications</code>) para optimizar futuras extracciones y reusabilidad.</li>
<li>Manejo de promociones: Procesamiento de datos de promociones (<code>precio_oferta</code>, <code>descuento</code>, <code>EnCompraDE</code>, <code>Unidades</code>, <code>fecha_fin</code>, <code>limitadoA</code>) para asegurar que el chatbot pueda aplicar la lógica de promociones correctamente.</li>
</ul></li>
</ul></li>
<li>Carga:
<ul>
<li>Los datos limpios y transformados se cargan en <strong>tres colecciones principales en MongoDB</strong>:
<ul>
<li><code>products</code>: Almacena la información principal de los productos.</li>
<li><code>sales</code>: Contiene los detalles de las promociones y ofertas vigentes.</li>
<li><code>specifications</code>: Respalda las fichas técnicas transformadas de los productos.</li>
</ul></li>
<li>Posteriormente, estos datos se recuperan de MongoDB y se convierten en objetos <code>Document</code> de LangChain, que son el formato estándar para la ingestión en bases de datos vectoriales. Se añaden metadatos relevantes como <code>clave</code> y <code>_id</code> de MongoDB a cada <code>Document</code>.</li>
</ul></li>
</ul>
<section id="generación-de-la-base-de-datos-vectorial" class="level3">
<h3 class="anchored" data-anchor-id="generación-de-la-base-de-datos-vectorial">Generación de la base de datos vectorial</h3>
<p>La base de datos vectorial es el corazón del sistema RAG:</p>
<ul>
<li>Proceso de creación:
<ul>
<li>El archivo <code>load.py</code> contiene la lógica principal. La función <code>load_products()</code> obtiene los documentos de productos desde MongoDB.</li>
<li>La función <code>vector_store()</code> crea un índice FAISS local utilizando <code>OpenAIEmbeddings</code> para generar las representaciones vectoriales de los documentos.</li>
<li>las colecciones de productos y ofertas se procesan y vectorizan en <strong>lotes (<code>batch_size = 250</code> para productos, <code>200</code> para ofertas)</strong>. Esta estrategia es crucial para manejar grandes volúmenes de datos sin agotar la memoria del sistema ni exceder los límites de tasa (rate limits) de la API de OpenAI.</li>
</ul></li>
<li>Inclusión de ofertas:
<ul>
<li>Las ofertas (<code>sales</code>) se añaden <em>incrementalmente</em> sobre el <em>vector store</em> de productos ya existente utilizando <code>vector_store.add_documents(sales)</code>. Esto evita la necesidad de re-vectorizar todo el catálogo.</li>
<li>Una copia del índice final, que combina productos y ofertas, se guarda en <code>SALES_PRODUCTS_VECTOR_PATH</code>.</li>
</ul></li>
</ul>
</section>
<section id="recomendaciones-para-futura-mejora" class="level3">
<h3 class="anchored" data-anchor-id="recomendaciones-para-futura-mejora">Recomendaciones para futura mejora</h3>
<ol type="1">
<li><strong>Embeddings locales (Ollama)</strong>:</li>
</ol>
<p>Para reducir los costos asociados con los <em>embeddings</em> de OpenAI y disminuir la dependencia de servicios externos, se recomienda realizar pruebas con los modelos de <em>embeddings</em> disponibles a través de Ollama (u otras librerías de <em>embeddings</em> locales).</p>
<ol start="2" type="1">
<li><strong>Indexado incremental</strong>:</li>
</ol>
<p>Actualmente, la actualización de la base vectorial puede implicar procesar grandes lotes. Para un mantenimiento más eficiente, especialmente si solo cambian algunos productos o sus precios/promociones, se podría implementar una función de actualización a nivel de producto.</p>
<ol start="3" type="1">
<li><strong>Monitoreo avanzado de rendimiento</strong>:</li>
</ol>
<p>Aunque ya se registran métricas de costo y duración, se puede profundizar en el monitoreo.</p>
<ol start="4" type="1">
<li><strong>Optimización del manejo de promociones complejas</strong>:</li>
</ol>
<p>Las promociones tipo “en compra X lleva Y” aún presenta desafíos. Podría ser necesario enriquecer el contexto del <em>embedding</em> para estos productos específicos, reglas más explícitas dentro del LLM o creación de plantillas de <em>prompts</em> más específicos para estas promociones.</p>
</section>
</section>
<section id="diagrama-de-arquitectura" class="level2" style="text-align: justify">
<h2 class="anchored" data-anchor-id="diagrama-de-arquitectura">Diagrama de arquitectura</h2>
<p>El siguiente diagrama ilustra la arquitectura general del ssitema del chatbot, mostrando los componentes principales y el flujo de datos desde la interacción del usuario hasta la generación de respuestas y el almacenamiento del historial. Se ha actualizado para reflejar la implementación de MongoDB y los diferentes flujos.</p>
<section id="componentes-clave" class="level3">
<h3 class="anchored" data-anchor-id="componentes-clave">Componentes clave:</h3>
<ul>
<li><strong>Interfaz de usuario (widget del chatbot)</strong>: El componente frontal incrustado en la página web de CT Internacional, permitiendo la interacción directa del usuario.</li>
<li><strong>Servicio intermediario PHP</strong>: Actúa como un puente seguro entre el <em>frontend</em> (HTTPS) y la API del chatbot (HTTPS pero con certificado autofirmado, o sea, no seguro) para resolver problemas de <em>contenido mixto</em>. Si el <em>backend</em> ya está en en HTTPS con un certificado SSL seguro, este componente puede ser obviado.</li>
<li><strong>API del chatbot (FastAPI)</strong>: El servicio <em>backend</em> principal que procesa las consultas de los usuarios, orquesta la recuperación de información y se comunica con los modelos de lenguaje.</li>
<li><strong>Base de datos de productos y promociones (MySQL)</strong>: Almacena la información transaccional y de precios de los productos y promociones de CT Internacional. Es la fuente original de los datos.</li>
<li><strong>Servicio de fichas técnicas</strong>: Fuente de datos para la información detallada y semi-estructurada (XML) de los productos.</li>
<li><strong>Módulo ETL</strong>: Proceso automatizado que:
<ul>
<li>Extrae datos de MySQL y el servicio de fichas técnicas.</li>
<li>Limpia, unifica, y transforma los datos, persistiendo las fichas técnicas en MongoDB.</li>
<li>Carga los datos limpios en colecciones de MongoDB (<code>products</code>, <code>sales</code>, <code>specifications</code>).</li>
</ul></li>
<li><strong>Base de datos NoSQL (MongoDB)</strong>: Almacena los datos limpios de productos, ofetas y fichas técnicas, así como el historial de las interacciones de los usuarios (<code>sessions</code>, <code>message_backup</code>).
<ul>
<li><code>sessions</code>: Mantiene los últimos <em>n</em> mensajes de cada usuario para recuperación rápida y una experiencia de usuario fluida.</li>
<li><code>message_backup</code>: Almacena un historial completo de todas las consultas y respuestas con métricas detalladas para fines de análisis y reportes.</li>
</ul></li>
<li><strong>Modelo de embeddings</strong>: Componente encargado de transformar tanto las consultas de los usuarios como la información de los productos en representaciones vectoriales numéricas (usando OpenAI Embeddings).</li>
<li><strong>Base de datos vectorial (FAISS)</strong>: Almacena las representaciones vectoriales de la información de productos y ofertas, permitiendo búsquedas de similitud eficientes. Se actualiza con datos del ETL.</li>
<li><strong>Clasificador de consultas (Ollama - <code>gemma3:12b</code>)</strong>: Componente central que, para consultas relevantes, coordina la búsqueda de información en la base de datos vectorial y contextualiza esta información con la consulta del usuario.</li>
<li><strong>LLM</strong>: El motor principal del chatbot para consultas relevantes, responsable de generar respuestas coherentes y detalladas en base a la consulta contextualizada por el RAG.</li>
<li><strong>Sistema de reportes automatizados</strong>: Procesa los datos del <code>message_backup</code> en MongoDB para generar <em>insights</em> sobre el uso del chatbot, intereses de los clientes, costos y rendimiento.</li>
</ul>
</section>
<section id="flujo-de-interacción-principal" class="level3">
<h3 class="anchored" data-anchor-id="flujo-de-interacción-principal">Flujo de interacción principal:</h3>
<ol type="1">
<li>El <strong>usuario</strong> interactúa con el <strong>widget del chatbot</strong> en la página web.</li>
<li>La consulta se envía a la <strong>API del chatbot</strong> (<strong>potencialmente vía el servicio intermediario PHP</strong>)</li>
<li>La <strong>API</strong> primero pasa consulta al <strong>clasificador de consultas</strong>.</li>
<li>Si la consulta es <em>relevante</em>:</li>
</ol>
<ul>
<li>Pasa por el <strong>modelo de embeddings</strong> y luego al <strong>módulo RAG</strong> para buscar en la <strong>base de datos vectorial</strong>.</li>
<li>La información recuperada se contextualiza y se envía al <strong>LLM</strong> para generar la <strong>respuesta al usuario</strong>.</li>
</ul>
<ol start="5" type="1">
<li>Si la consulta es <em>irrelevante</em> o <em>inapropiada</em>, el <strong>clasificador</strong> genera una respuesta adecuada (cortés o de advertencia) directamente al <strong>usuario</strong>.</li>
<li>Todas las interacciones (consultas y respuestas) se registran en las colecciones <code>sessions</code> y <code>message_backup</code> en <strong>MongoDB</strong>.</li>
<li>El <strong>sistema de reportes automatizados</strong> accede a <code>message_backup</code> para generar análisis de datos.</li>
</ol>
</section>
<section id="flujo-de-datos" class="level3">
<h3 class="anchored" data-anchor-id="flujo-de-datos">Flujo de datos</h3>
<ol type="1">
<li>El <strong>módulo ETL</strong> extrae datos de <strong>MySQL</strong> y el <strong>servicio de fichas técnicas</strong>.</li>
<li>Los datos se transforman y se cargan en <strong>MongoDB</strong> (colecciones <code>products</code>, <code>sales</code>, <code>specifications</code>).</li>
<li>Los datos de <code>products</code> y <code>sales</code> en <strong>MongoDB</strong> son utilizados por el <strong>módulo ETL</strong> para construir y actualizar la <strong>base de datos vectorial</strong></li>
</ol>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="./arquitectura.jpg" class="img-fluid figure-img" style="width:90.0%"></p>
<figcaption>Arquitectura del sistema</figcaption>
</figure>
</div>
</section>
</section>



<a onclick="window.scrollTo(0, 0); return false;" role="button" id="quarto-back-to-top"><i class="bi bi-arrow-up"></i> Back to top</a></main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const disableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'prefetch';
    }
  }
  const enableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'stylesheet';
    }
  }
  const manageTransitions = (selector, allowTransitions) => {
    const els = window.document.querySelectorAll(selector);
    for (let i=0; i < els.length; i++) {
      const el = els[i];
      if (allowTransitions) {
        el.classList.remove('notransition');
      } else {
        el.classList.add('notransition');
      }
    }
  }
  const toggleGiscusIfUsed = (isAlternate, darkModeDefault) => {
    const baseTheme = document.querySelector('#giscus-base-theme')?.value ?? 'light';
    const alternateTheme = document.querySelector('#giscus-alt-theme')?.value ?? 'dark';
    let newTheme = '';
    if(darkModeDefault) {
      newTheme = isAlternate ? baseTheme : alternateTheme;
    } else {
      newTheme = isAlternate ? alternateTheme : baseTheme;
    }
    const changeGiscusTheme = () => {
      // From: https://github.com/giscus/giscus/issues/336
      const sendMessage = (message) => {
        const iframe = document.querySelector('iframe.giscus-frame');
        if (!iframe) return;
        iframe.contentWindow.postMessage({ giscus: message }, 'https://giscus.app');
      }
      sendMessage({
        setConfig: {
          theme: newTheme
        }
      });
    }
    const isGiscussLoaded = window.document.querySelector('iframe.giscus-frame') !== null;
    if (isGiscussLoaded) {
      changeGiscusTheme();
    }
  }
  const toggleColorMode = (alternate) => {
    // Switch the stylesheets
    const alternateStylesheets = window.document.querySelectorAll('link.quarto-color-scheme.quarto-color-alternate');
    manageTransitions('#quarto-margin-sidebar .nav-link', false);
    if (alternate) {
      enableStylesheet(alternateStylesheets);
      for (const sheetNode of alternateStylesheets) {
        if (sheetNode.id === "quarto-bootstrap") {
          toggleBodyColorMode(sheetNode);
        }
      }
    } else {
      disableStylesheet(alternateStylesheets);
      toggleBodyColorPrimary();
    }
    manageTransitions('#quarto-margin-sidebar .nav-link', true);
    // Switch the toggles
    const toggles = window.document.querySelectorAll('.quarto-color-scheme-toggle');
    for (let i=0; i < toggles.length; i++) {
      const toggle = toggles[i];
      if (toggle) {
        if (alternate) {
          toggle.classList.add("alternate");     
        } else {
          toggle.classList.remove("alternate");
        }
      }
    }
    // Hack to workaround the fact that safari doesn't
    // properly recolor the scrollbar when toggling (#1455)
    if (navigator.userAgent.indexOf('Safari') > 0 && navigator.userAgent.indexOf('Chrome') == -1) {
      manageTransitions("body", false);
      window.scrollTo(0, 1);
      setTimeout(() => {
        window.scrollTo(0, 0);
        manageTransitions("body", true);
      }, 40);  
    }
  }
  const isFileUrl = () => { 
    return window.location.protocol === 'file:';
  }
  const hasAlternateSentinel = () => {  
    let styleSentinel = getColorSchemeSentinel();
    if (styleSentinel !== null) {
      return styleSentinel === "alternate";
    } else {
      return false;
    }
  }
  const setStyleSentinel = (alternate) => {
    const value = alternate ? "alternate" : "default";
    if (!isFileUrl()) {
      window.localStorage.setItem("quarto-color-scheme", value);
    } else {
      localAlternateSentinel = value;
    }
  }
  const getColorSchemeSentinel = () => {
    if (!isFileUrl()) {
      const storageValue = window.localStorage.getItem("quarto-color-scheme");
      return storageValue != null ? storageValue : localAlternateSentinel;
    } else {
      return localAlternateSentinel;
    }
  }
  const darkModeDefault = false;
  let localAlternateSentinel = darkModeDefault ? 'alternate' : 'default';
  // Dark / light mode switch
  window.quartoToggleColorScheme = () => {
    // Read the current dark / light value 
    let toAlternate = !hasAlternateSentinel();
    toggleColorMode(toAlternate);
    setStyleSentinel(toAlternate);
    toggleGiscusIfUsed(toAlternate, darkModeDefault);
  };
  // Ensure there is a toggle, if there isn't float one in the top right
  if (window.document.querySelector('.quarto-color-scheme-toggle') === null) {
    const a = window.document.createElement('a');
    a.classList.add('top-right');
    a.classList.add('quarto-color-scheme-toggle');
    a.href = "";
    a.onclick = function() { try { window.quartoToggleColorScheme(); } catch {} return false; };
    const i = window.document.createElement("i");
    i.classList.add('bi');
    a.appendChild(i);
    window.document.body.appendChild(a);
  }
  // Switch to dark mode if need be
  if (hasAlternateSentinel()) {
    toggleColorMode(true);
  } else {
    toggleColorMode(false);
  }
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>